<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>Starting on Palladium | My Dearest</title><meta name="author" content="Animenzzzzzz"><meta name="copyright" content="Animenzzzzzz"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="Introduction If you’ve been following the development of Iridium, you know how heavily it uses Nom to parse the assembly language. I hope you liked it, because we’re going to be using Nom for this">
<meta property="og:type" content="article">
<meta property="og:title" content="Starting on Palladium">
<meta property="og:url" content="https://animenzzzzzz.github.io/pages/build-your-own-vm/19/index.html">
<meta property="og:site_name" content="My Dearest">
<meta property="og:description" content="Introduction If you’ve been following the development of Iridium, you know how heavily it uses Nom to parse the assembly language. I hope you liked it, because we’re going to be using Nom for this">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://animenzzzzzz.github.io/img/avatar.jpg">
<meta property="article:published_time" content="2024-12-31T08:04:56.000Z">
<meta property="article:modified_time" content="2025-01-03T07:36:04.557Z">
<meta property="article:author" content="Animenzzzzzz">
<meta property="article:tag" content="virtual-machine">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://animenzzzzzz.github.io/img/avatar.jpg"><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="https://animenzzzzzz.github.io/pages/build-your-own-vm/19/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css"><script>(()=>{
      const saveToLocal = {
        set: (key, value, ttl) => {
          if (ttl === 0) return
          const now = Date.now()
          const expiry = now + ttl * 86400000
          const item = {
            value,
            expiry
          }
          localStorage.setItem(key, JSON.stringify(item))
        },
      
        get: key => {
          const itemStr = localStorage.getItem(key)
      
          if (!itemStr) {
            return undefined
          }
          const item = JSON.parse(itemStr)
          const now = Date.now()
      
          if (now > item.expiry) {
            localStorage.removeItem(key)
            return undefined
          }
          return item.value
        }
      }
      
      window.btf = {
        saveToLocal: saveToLocal,
        getScript: (url, attr = {}) => new Promise((resolve, reject) => {
          const script = document.createElement('script')
          script.src = url
          script.async = true
          script.onerror = reject
          script.onload = script.onreadystatechange = function() {
            const loadState = this.readyState
            if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
            script.onload = script.onreadystatechange = null
            resolve()
          }

          Object.keys(attr).forEach(key => {
            script.setAttribute(key, attr[key])
          })

          document.head.appendChild(script)
        }),

        getCSS: (url, id = false) => new Promise((resolve, reject) => {
          const link = document.createElement('link')
          link.rel = 'stylesheet'
          link.href = url
          if (id) link.id = id
          link.onerror = reject
          link.onload = link.onreadystatechange = function() {
            const loadState = this.readyState
            if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
            link.onload = link.onreadystatechange = null
            resolve()
          }
          document.head.appendChild(link)
        }),

        addGlobalFn: (key, fn, name = false, parent = window) => {
          const pjaxEnable = false
          if (!pjaxEnable && key.startsWith('pjax')) return

          const globalFn = parent.globalFn || {}
          const keyObj = globalFn[key] || {}
    
          if (name && keyObj[name]) return
    
          name = name || Object.keys(keyObj).length
          keyObj[name] = fn
          globalFn[key] = keyObj
          parent.globalFn = globalFn
        }
      }
    
      const activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      const activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }

      btf.activateDarkMode = activateDarkMode
      btf.activateLightMode = activateLightMode
      
      const t = saveToLocal.get('theme')
    
        if (t === 'dark') activateDarkMode()
        else if (t === 'light') activateLightMode()
      
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
      const detectApple = () => {
        if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
          document.documentElement.classList.add('apple')
        }
      }
      detectApple()
    })()</script><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false,"highlightFullpage":false,"highlightMacStyle":false},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  dateSuffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'null',
  Snackbar: undefined,
  infinitegrid: {
    js: 'https://cdn.jsdelivr.net/npm/@egjs/infinitegrid/dist/infinitegrid.min.js',
    buttonText: '加载更多'
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: false,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'Starting on Palladium',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2025-01-03 15:36:04'
}</script><link rel="stylesheet" href="/css/font.css"><meta name="generator" content="Hexo 7.3.0"></head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="/img/avatar.jpg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">69</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">16</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">12</div></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url(/img/top_img.jpg);"><nav id="nav"><span id="blog-info"><a href="/" title="My Dearest"><span class="site-name">My Dearest</span></a></span><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div></div><div id="toggle-menu"><span class="site-page"><i class="fas fa-bars fa-fw"></i></span></div></div></nav><div id="post-info"><h1 class="post-title">Starting on Palladium</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2024-12-31T08:04:56.000Z" title="发表于 2024-12-31 16:04:56">2024-12-31</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2025-01-03T07:36:04.557Z" title="更新于 2025-01-03 15:36:04">2025-01-03</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/Computer/">Computer</a><i class="fas fa-angle-right post-meta-separator"></i><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/Computer/Virtual-Machine/">Virtual Machine</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="Starting on Palladium"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h2 id="introduction">Introduction</h2>
<p>If you’ve been following the development of Iridium, you know how
heavily it uses <code>Nom</code> to parse the assembly language. I hope
you liked it, because we’re going to be using <code>Nom</code> for this
as well. =)</p>
<p>In this tutorial, we’re going to start creating a language called
<code>Palladium</code> that will compile down to the assembly code we’ve
been using. Before we get started, please remember…​</p>
<p>I read the <a
target="_blank" rel="noopener" href="https://llvm.org/docs/tutorial/MyFirstLanguageFrontend/index.html">LLVM
Kaleidoscope Tutorial</a> and that’s pretty much it. If you see
something horrific I’ve done, have suggestions, etc, please let me
know.</p>
<h2 id="flow">Flow</h2>
<p>This language complements the Iridium VM, and coupled with it. A
diagram of the flow looks something like:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">+------------------+      +------------------+      +------------------+</span><br><span class="line">|    Palladium     |  -&gt;  |   Iridium ASM    |  -&gt;  |   Iridium VM     |</span><br><span class="line">+------------------+      +------------------+      +------------------+</span><br></pre></td></tr></table></figure>
<h2 id="goals">Goals</h2>
<p>We’re going to start off easy for this tutorial. Our goal is to write
a compiler that will transform this:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">1 + 2</span><br></pre></td></tr></table></figure>
<p>into this:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">LOAD $0 #1</span><br><span class="line">LOAD $1 #2</span><br><span class="line">ADD $0 $1 $2</span><br></pre></td></tr></table></figure>
<h2 id="parsers">Parsers</h2>
<p>Here’s the parsers we’ll need:</p>
<ol type="1">
<li>Operator (+,-,/,*)</li>
<li>Integer</li>
<li>Expression</li>
<li>Program</li>
</ol>
<p>Let’s get started!</p>
<h3 id="step-1-new-project">Step 1: New Project</h3>
<ol type="1">
<li>Run <code>cargo new palladium</code></li>
<li>In <code>Cargo.toml</code>, add <code>nom = "^4.0"</code> to the
dependencies</li>
</ol>
<h3 id="step-2-tokens">Step 2: Tokens</h3>
<p>In <code>src/</code> create a file called <code>tokens.rs</code> and
put this in it:</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#[derive(Debug, PartialEq)]</span></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">enum</span> <span class="title class_">Token</span> &#123;</span><br><span class="line">    AdditionOperator,</span><br><span class="line">    SubtractionOperator,</span><br><span class="line">    MultiplicationOperator,</span><br><span class="line">    DivisionOperator,</span><br><span class="line">    Integer&#123; value: <span class="type">i64</span> &#125;,</span><br><span class="line">    Expression&#123; left: <span class="type">Box</span>&lt;Token&gt;, op: <span class="type">Box</span>&lt;Token&gt;, right: <span class="type">Box</span>&lt;Token&gt; &#125;,</span><br><span class="line">    Program&#123; expressions: <span class="type">Vec</span>&lt;Token&gt; &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>These are the tokens <code>Nom</code> will be spewing out as it chews
through our code.</p>
<blockquote>
<p>Note how we have to use some form of indirection with Expressions and
Program; this is because at compile time we don’t know the sizes (due to
the recursion) and would have to allocate an infinite amount of memory.
Using Box or Vec solves the problem by using pointers, which have a
known size.</p>
</blockquote>
<h3 id="step-3-operator-parsers">Step 3: Operator Parsers</h3>
<p>Now make a file called <code>src/operator_parsers.rs</code>. We’ll
need 5 parsers here, one for each operator, and then one that uses
<code>alt!</code> to check for each of them. Here’s the addition
operator parser:</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">named!(addition_operator&lt;CompleteStr, Token&gt;,</span><br><span class="line">    ws!(</span><br><span class="line">        do_parse!(</span><br><span class="line">            tag!(<span class="string">&quot;+&quot;</span>) &gt;&gt;</span><br><span class="line">            (</span><br><span class="line">                Token::AdditionOperator</span><br><span class="line">            )</span><br><span class="line">        )</span><br><span class="line">    )</span><br><span class="line">);</span><br></pre></td></tr></table></figure>
<p>The rest are nearly identical, so I won’t show them here. A parser
that checks for each of those four is a bit trickier:</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">named!(operator&lt;CompleteStr, Token&gt;,</span><br><span class="line">    ws!(</span><br><span class="line">        alt!(</span><br><span class="line">            addition_operator |</span><br><span class="line">            subtraction_operator |</span><br><span class="line">            multiplication_operator |</span><br><span class="line">            division_operator</span><br><span class="line">        )</span><br><span class="line">    )</span><br><span class="line">);</span><br></pre></td></tr></table></figure>
<h3 id="step-4-operand-parsers">Step 4: Operand Parsers</h3>
<p>This is similar to the above. Right now, we only have integers as
operands, but as we continue, we’ll add in more.</p>
<p>Make <code>src/operand_parsers.rs</code>, and in it put:</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/// Parses an integer</span></span><br><span class="line">named!(integer&lt;CompleteStr, Token&gt;,</span><br><span class="line">    ws!(</span><br><span class="line">        do_parse!(</span><br><span class="line">            sign: opt!(tag!(<span class="string">&quot;-&quot;</span>)) &gt;&gt;</span><br><span class="line">            reg_num: digit &gt;&gt;</span><br><span class="line">            (</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">tmp</span> = <span class="type">String</span>::<span class="title function_ invoke__">from</span>(<span class="string">&quot;&quot;</span>);</span><br><span class="line">                    <span class="keyword">if</span> sign.<span class="title function_ invoke__">is_some</span>() &#123;</span><br><span class="line">                        tmp.<span class="title function_ invoke__">push_str</span>(<span class="string">&quot;-&quot;</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                    tmp.<span class="title function_ invoke__">push_str</span>(&amp;reg_num.<span class="title function_ invoke__">to_string</span>());</span><br><span class="line">                    <span class="keyword">let</span> <span class="variable">converted</span> = tmp.parse::&lt;<span class="type">i64</span>&gt;().<span class="title function_ invoke__">unwrap</span>();</span><br><span class="line">                    Token::Integer&#123; value: converted &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            )</span><br><span class="line">        )</span><br><span class="line">    )</span><br><span class="line">);</span><br></pre></td></tr></table></figure>
<p>Note the sign: <code>opt!(tag!("-"))</code> line. This will let us
handle 64-bit positive or negative integers.</p>
<h3 id="statements-and-expressions">Statements and Expressions</h3>
<p>Before moving on, let’s cover what these two things are and how they
are used in a programming language context.</p>
<h4 id="expression">Expression</h4>
<p>An expression is something that produces a new value. This can be a
combination of functions and other values. <code>5</code> is a value,
for example. Another way to think about it is that expressions are
something.</p>
<h4 id="statement">Statement</h4>
<p>Statements do not return an expression. For example,
<code>x = 5</code> is a statement, because it doesn’t produce any new
values. <code>x</code> and <code>5</code> are both values, though. You
can think of statements as doing something.</p>
<h4 id="tests">Tests</h4>
<p>Oh, right, tests for the operand parsers:</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">mod</span> tests &#123;</span><br><span class="line">    <span class="keyword">use</span> super::*;</span><br><span class="line">    <span class="keyword">use</span> tokens::Token;</span><br><span class="line">    <span class="keyword">use</span> nom::types::CompleteStr;</span><br><span class="line"></span><br><span class="line">    <span class="meta">#[test]</span></span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">test_parse_integer</span>() &#123;</span><br><span class="line">        <span class="keyword">let</span> <span class="variable">test_integers</span> = <span class="built_in">vec!</span>[<span class="string">&quot;0&quot;</span>, <span class="string">&quot;-1&quot;</span>, <span class="string">&quot;1&quot;</span>];</span><br><span class="line">        <span class="keyword">for</span> <span class="variable">o</span> <span class="keyword">in</span> test_integers &#123;</span><br><span class="line">            <span class="keyword">let</span> <span class="variable">parsed_o</span> = o.parse::&lt;<span class="type">i64</span>&gt;().<span class="title function_ invoke__">unwrap</span>();</span><br><span class="line">            <span class="keyword">let</span> <span class="variable">result</span> = <span class="title function_ invoke__">integer</span>(<span class="title function_ invoke__">CompleteStr</span>(o));</span><br><span class="line">            <span class="built_in">assert_eq!</span>(result.<span class="title function_ invoke__">is_ok</span>(), <span class="literal">true</span>);</span><br><span class="line">            <span class="keyword">let</span> (_, token) = result.<span class="title function_ invoke__">unwrap</span>();</span><br><span class="line">            <span class="built_in">assert_eq!</span>(token, Token::Integer&#123;value: parsed_o&#125;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>I tried to be a bit more clever and not write three different test
cases for 0, -1, and 1.</p>
<h3 id="step-5-expression-parser">Step 5: Expression Parser</h3>
<p>We have parsers for operands and operators. Since <code>1 + 2</code>
is a combination of operands and an operator that returns a value (3),
that means its an expression. Thus, we need an expression parser. Make
<code>src/expression_parsers.rs</code> and in it put:</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> nom::types::CompleteStr;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> tokens::Token;</span><br><span class="line"><span class="keyword">use</span> operand_parsers::operand;</span><br><span class="line"><span class="keyword">use</span> operator_parsers::operator;</span><br><span class="line"></span><br><span class="line">named!(<span class="keyword">pub</span> expression&lt;CompleteStr, Token&gt;,</span><br><span class="line">    ws!(</span><br><span class="line">        do_parse!(</span><br><span class="line">            left: operand &gt;&gt;</span><br><span class="line">            op: operator &gt;&gt;</span><br><span class="line">            right: operand &gt;&gt;</span><br><span class="line">            (</span><br><span class="line">                Token::Expression&#123;</span><br><span class="line">                    left: <span class="type">Box</span>::<span class="title function_ invoke__">new</span>(left),</span><br><span class="line">                    right: <span class="type">Box</span>::<span class="title function_ invoke__">new</span>(right),</span><br><span class="line">                    op: <span class="type">Box</span>::<span class="title function_ invoke__">new</span>(op)</span><br><span class="line">                &#125;</span><br><span class="line">            )</span><br><span class="line">        )</span><br><span class="line">    )</span><br><span class="line">);</span><br></pre></td></tr></table></figure>
<h3 id="step-6-program-parser">Step 6: Program Parser</h3>
<p>This is the top-most parser, Program! Make
<code>src/program_parser.rs</code> and in it put:</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> nom::types::CompleteStr;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> expression_parsers::*;</span><br><span class="line"><span class="keyword">use</span> tokens::Token;</span><br><span class="line"></span><br><span class="line">named!(program&lt;CompleteStr, Token&gt;,</span><br><span class="line">    ws!(</span><br><span class="line">        do_parse!(</span><br><span class="line">            expressions: many1!(expression) &gt;&gt;</span><br><span class="line">            (</span><br><span class="line">                Token::Program &#123;</span><br><span class="line">                    expressions: expressions</span><br><span class="line">                &#125;</span><br><span class="line">            )</span><br><span class="line">        )</span><br><span class="line">    )</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="keyword">mod</span> tests &#123;</span><br><span class="line">    <span class="keyword">use</span> super::*;</span><br><span class="line">    <span class="meta">#[test]</span></span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">test_parse_program</span>() &#123;</span><br><span class="line">        <span class="keyword">let</span> <span class="variable">test_program</span> = <span class="title function_ invoke__">CompleteStr</span>(<span class="string">&quot;1+2&quot;</span>);</span><br><span class="line">        <span class="keyword">let</span> <span class="variable">result</span> = <span class="title function_ invoke__">program</span>(test_program);</span><br><span class="line">        <span class="built_in">assert_eq!</span>(result.<span class="title function_ invoke__">is_ok</span>(), <span class="literal">true</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Let’s print out the result from <code>test_parser_program</code>:</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">Program &#123;</span><br><span class="line">    expressions: [</span><br><span class="line">        Expression &#123;</span><br><span class="line">            left: Integer &#123;</span><br><span class="line">                value: <span class="number">1</span></span><br><span class="line">            &#125;,</span><br><span class="line">            op: AdditionOperator,</span><br><span class="line">            right: Integer &#123;</span><br><span class="line">                value: <span class="number">2</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Notice the tree-like structure? This is an <code>AST</code>, or
<code>Abstract Syntax Tree</code>. I’m not going to go into exhaustive
detail explaining what they are here since there are explanations better
than what I could do:</p>
<ul>
<li><a
target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Abstract_syntax_tree">Wikipedia
Article</a></li>
<li><a target="_blank" rel="noopener" href="http://astexplorer.net/">Nifty Tool for Visualizing
ASTs</a></li>
</ul>
<p>A quick summary is that our <code>Nom</code> parser transforms our
source text into a data structure. Its called an abstract syntax tree
because the parser removes information, such as comments, whitespace,
etc. A concrete syntax tree would preserve all of that. Why use ASTs? So
we can do…​</p>
<h3 id="step-7-code-generation">Step 7: Code Generation!</h3>
<p>(For some reason, this is my favorite part of writing a programming
language) Now that we have a tree representing our program, we want to
output appropriate assembler code that the Iridium VM can then compile
into executable bytecode.</p>
<h4 id="visitor-pattern">Visitor Pattern</h4>
<p>One way to do this is called the <code>Visitor</code> pattern. Think
of it is as writing a program that visits each node in our tree,
examines it, and outputs the IASM code. This pattern is useful when you
need to do something across a collection of different objects.</p>
<p>To do this, let’s use Traits! Make <code>src/visitor.rs</code>. This
part gets a bit complicated, so we’ll do it in segments. First, put this
in the file:</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> tokens::Token;</span><br><span class="line"></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">trait</span> <span class="title class_">Visitor</span> &#123;</span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">visit_token</span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>, node: &amp;Token);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Here we define a Trait called Visitor. There’s one function,
<code>visit_token</code>, and it accepts a mutable reference to self and
a reference to a <code>Token</code>. Because we used enums in
<code>tokens.rs</code>, we cannot define the trait like this:</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">pub</span> <span class="keyword">trait</span> <span class="title class_">Visitor</span> &#123;</span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">visit_addition_operator</span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>, node: &amp;Token::AdditionOperator);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Enum variants are not types. We could use this method if we had
implemented each enum variant as a struct instead. I have a serious
addiction to Rust’s enums, though.</p>
<p>Next, put in this:</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">pub</span> <span class="keyword">struct</span> <span class="title class_">Compiler</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span> <span class="title class_">Visitor</span> <span class="keyword">for</span> <span class="title class_">Compiler</span> &#123;</span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">visit_token</span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>, node: &amp;Token) &#123;</span><br><span class="line">        <span class="keyword">match</span> node &#123;</span><br><span class="line">            &amp;Token::AdditionOperator =&gt; &#123;&#125;,</span><br><span class="line">            &amp;Token::SubtractionOperator =&gt; &#123;&#125;,</span><br><span class="line">            &amp;Token::MultiplicationOperator =&gt; &#123;&#125;,</span><br><span class="line">            &amp;Token::DivisionOperator =&gt; &#123;&#125;,</span><br><span class="line">            &amp;Token::Integer&#123; value &#125; =&gt; &#123;&#125;,</span><br><span class="line">            &amp;Token::Expression&#123; <span class="keyword">ref</span> left, <span class="keyword">ref</span> op, <span class="keyword">ref</span> right &#125; =&gt; &#123;&#125;,</span><br><span class="line">            &amp;Token::Program&#123; <span class="keyword">ref</span> expressions &#125; =&gt; &#123;&#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>We declare an empty struct called <code>Compiler</code>, and then we
implement the Visitor Trait for it.</p>
<blockquote>
<p>The match section is how we deal with enum variants not being types.
The Compiler will visit each node, each of which is of type
<code>Token</code>, and then it will use matching to determine what
further functions to call.</p>
</blockquote>
<p>To illustrate this, I’ve added some debug prints to the various match
arms:</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">fn</span> <span class="title function_">visit_token</span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>, node: &amp;Token) &#123;</span><br><span class="line">    <span class="keyword">match</span> node &#123;</span><br><span class="line">        &amp;Token::AdditionOperator =&gt; &#123;</span><br><span class="line">            <span class="built_in">println!</span>(<span class="string">&quot;Visiting AdditionOperator&quot;</span>);</span><br><span class="line">        &#125;,</span><br><span class="line">        &amp;Token::SubtractionOperator =&gt; &#123;&#125;,</span><br><span class="line">        &amp;Token::MultiplicationOperator =&gt; &#123;&#125;,</span><br><span class="line">        &amp;Token::DivisionOperator =&gt; &#123;&#125;,</span><br><span class="line">        &amp;Token::Integer&#123; value &#125; =&gt; &#123;</span><br><span class="line">            <span class="built_in">println!</span>(<span class="string">&quot;Visited Integer with value of: &#123;:#?&#125;&quot;</span>, value);</span><br><span class="line">        &#125;,</span><br><span class="line">        &amp;Token::Expression&#123; <span class="keyword">ref</span> left, <span class="keyword">ref</span> op, <span class="keyword">ref</span> right &#125; =&gt; &#123;</span><br><span class="line">            <span class="built_in">println!</span>(<span class="string">&quot;Visiting an expression&quot;</span>);</span><br><span class="line">            <span class="keyword">self</span>.<span class="title function_ invoke__">visit_token</span>(left);</span><br><span class="line">            <span class="keyword">self</span>.<span class="title function_ invoke__">visit_token</span>(op);</span><br><span class="line">            <span class="keyword">self</span>.<span class="title function_ invoke__">visit_token</span>(right);</span><br><span class="line">            <span class="built_in">println!</span>(<span class="string">&quot;Done visiting expression&quot;</span>);</span><br><span class="line">        &#125;,</span><br><span class="line">        &amp;Token::Program&#123; <span class="keyword">ref</span> expressions &#125; =&gt; &#123;</span><br><span class="line">            <span class="built_in">println!</span>(<span class="string">&quot;Visiting program&quot;</span>);</span><br><span class="line">            <span class="keyword">for</span> <span class="variable">expression</span> <span class="keyword">in</span> expressions &#123;</span><br><span class="line">                <span class="keyword">self</span>.<span class="title function_ invoke__">visit_token</span>(expression);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="built_in">println!</span>(<span class="string">&quot;Done visiting program&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>We’ll remove those later, but for now, it will help illustrate how
this works.</p>
<h4 id="tests-1">Tests</h4>
<p>Here’s a simple test to put in <code>visitor.rs</code>:</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">mod</span> tests &#123;</span><br><span class="line">    <span class="keyword">use</span> super::*;</span><br><span class="line">    <span class="keyword">use</span> nom::types::CompleteStr;</span><br><span class="line">    <span class="keyword">use</span> program_parsers::program;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">generate_test_program</span>() <span class="punctuation">-&gt;</span> Token &#123;</span><br><span class="line">        <span class="keyword">let</span> <span class="variable">source</span> = <span class="title function_ invoke__">CompleteStr</span>(<span class="string">&quot;1+2&quot;</span>);</span><br><span class="line">        <span class="keyword">let</span> (_, tree) = <span class="title function_ invoke__">program</span>(source).<span class="title function_ invoke__">unwrap</span>();</span><br><span class="line">        tree</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">#[test]</span></span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">test_visit_addition_token</span>() &#123;</span><br><span class="line">        <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">compiler</span> = Compiler&#123;&#125;;</span><br><span class="line">        <span class="keyword">let</span> <span class="variable">test_program</span> = <span class="title function_ invoke__">generate_test_program</span>();</span><br><span class="line">        compiler.<span class="title function_ invoke__">visit_token</span>(&amp;test_program);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>And if we run the test, we get:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">$ cargo test test_visit_addition_token -- --nocapture</span><br><span class="line">    Finished dev [unoptimized + debuginfo] target(s) in 0.03s</span><br><span class="line">     Running target/debug/deps/palladium-2f91df5ee61c7967</span><br><span class="line"></span><br><span class="line">running 1 test</span><br><span class="line">Visiting program</span><br><span class="line">Visiting an expression</span><br><span class="line">Visited Integer with value of: 1</span><br><span class="line">Visiting AdditionOperator</span><br><span class="line">Visited Integer with value of: 2</span><br><span class="line">Done visiting expression</span><br><span class="line">Done visiting program</span><br><span class="line">test visitor::tests::test_visit_addition_token ... ok</span><br><span class="line"></span><br><span class="line">test result: ok. 1 passed; 0 failed; 0 ignored; 0 measured; 8 filtered out</span><br></pre></td></tr></table></figure>
<p>Pretty cool, huh? We’re almost there!</p>
<h2 id="tokenscompile">Tokens…​COMPILE!</h2>
<p>Because our VM is register-based, we have to worry about something
called register allocation. Our compiler has to track which registers
are in use, and which ones are not. In the case of our example program,
<code>1+2</code>, we need three registers. Why three? Consider the steps
needed:</p>
<ol type="1">
<li>Load <code>1</code> into register <code>0</code></li>
<li>Load <code>2</code> into a register <code>1</code></li>
<li>Add the first two registers</li>
<li>Store the result in a third register <code>2</code></li>
<li>Registers <code>0</code> and <code>1</code> are free again for
use</li>
</ol>
<p>With that in mind, let’s change our Compiler struct a bit. Well, a
lot:</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#[derive(Default)]</span></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">struct</span> <span class="title class_">Compiler</span>&#123;</span><br><span class="line">    free_registers: <span class="type">Vec</span>&lt;<span class="type">u8</span>&gt;,</span><br><span class="line">    used_registers: <span class="type">Vec</span>&lt;<span class="type">u8</span>&gt;,</span><br><span class="line">    assembly: <span class="type">Vec</span>&lt;<span class="type">String</span>&gt;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span> <span class="title class_">Compiler</span> &#123;</span><br><span class="line">    <span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">new</span>() <span class="punctuation">-&gt;</span> Compiler &#123;</span><br><span class="line">        <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">free_registers</span> = <span class="built_in">vec!</span>[];</span><br><span class="line">        <span class="keyword">for</span> <span class="variable">i</span> <span class="keyword">in</span> <span class="number">0</span>..<span class="number">31</span> &#123;</span><br><span class="line">            free_registers.<span class="title function_ invoke__">push</span>(i);</span><br><span class="line">        &#125;</span><br><span class="line">        free_registers.<span class="title function_ invoke__">reverse</span>();</span><br><span class="line">        Compiler&#123;</span><br><span class="line">            free_registers: free_registers,</span><br><span class="line">            used_registers: <span class="built_in">vec!</span>[],</span><br><span class="line">            assembly: <span class="built_in">vec!</span>[]</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>We added three new attributes: a vector to store registers that are
free to use, one to store registers current in use, and a vector of
<code>Strings</code> to hold the final output.</p>
<blockquote>
<p>We reverse the free registers vector so it starts allocating from 0.
Not that it matters, it just annoys me for some reason.</p>
</blockquote>
<p>Ready for the final version of the visit_token function? Here we
go…​</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">impl</span> <span class="title class_">Visitor</span> <span class="keyword">for</span> <span class="title class_">Compiler</span> &#123;</span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">visit_token</span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>, node: &amp;Token) &#123;</span><br><span class="line">        <span class="keyword">match</span> node &#123;</span><br><span class="line">            &amp;Token::AdditionOperator =&gt; &#123;</span><br><span class="line">                <span class="comment">// <span class="doctag">TODO:</span> Need to clean this up. Remove the unwraps.</span></span><br><span class="line">                <span class="keyword">let</span> <span class="variable">result_register</span> = <span class="keyword">self</span>.free_registers.<span class="title function_ invoke__">pop</span>().<span class="title function_ invoke__">unwrap</span>();</span><br><span class="line">                <span class="keyword">let</span> <span class="variable">left_register</span> = <span class="keyword">self</span>.used_registers.<span class="title function_ invoke__">pop</span>().<span class="title function_ invoke__">unwrap</span>();</span><br><span class="line">                <span class="keyword">let</span> <span class="variable">right_register</span> = <span class="keyword">self</span>.used_registers.<span class="title function_ invoke__">pop</span>().<span class="title function_ invoke__">unwrap</span>();</span><br><span class="line">                <span class="keyword">let</span> <span class="variable">line</span> = <span class="built_in">format!</span>(<span class="string">&quot;ADD $&#123;&#125; $&#123;&#125; $&#123;&#125;&quot;</span>, left_register, right_register, result_register);</span><br><span class="line">                <span class="keyword">self</span>.assembly.<span class="title function_ invoke__">push</span>(line);</span><br><span class="line">                <span class="keyword">self</span>.free_registers.<span class="title function_ invoke__">push</span>(left_register);</span><br><span class="line">                <span class="keyword">self</span>.free_registers.<span class="title function_ invoke__">push</span>(right_register);</span><br><span class="line"></span><br><span class="line">            &#125;,</span><br><span class="line">            &amp;Token::SubtractionOperator =&gt; &#123;&#125;,</span><br><span class="line">            &amp;Token::MultiplicationOperator =&gt; &#123;&#125;,</span><br><span class="line">            &amp;Token::DivisionOperator =&gt; &#123;&#125;,</span><br><span class="line">            &amp;Token::Integer&#123; value &#125; =&gt; &#123;</span><br><span class="line">                <span class="keyword">let</span> <span class="variable">next_register</span> = <span class="keyword">self</span>.free_registers.<span class="title function_ invoke__">pop</span>().<span class="title function_ invoke__">unwrap</span>();</span><br><span class="line">                <span class="keyword">let</span> <span class="variable">line</span> = <span class="built_in">format!</span>(<span class="string">&quot;LOAD $&#123;&#125; #&#123;&#125;&quot;</span>, next_register, value);</span><br><span class="line">                <span class="keyword">self</span>.used_registers.<span class="title function_ invoke__">push</span>(next_register);</span><br><span class="line">                <span class="keyword">self</span>.assembly.<span class="title function_ invoke__">push</span>(line);</span><br><span class="line">            &#125;,</span><br><span class="line">            &amp;Token::Expression&#123; <span class="keyword">ref</span> left, <span class="keyword">ref</span> op, <span class="keyword">ref</span> right &#125; =&gt; &#123;</span><br><span class="line">                <span class="keyword">self</span>.<span class="title function_ invoke__">visit_token</span>(left);</span><br><span class="line">                <span class="keyword">self</span>.<span class="title function_ invoke__">visit_token</span>(right);</span><br><span class="line">                <span class="keyword">self</span>.<span class="title function_ invoke__">visit_token</span>(op);</span><br><span class="line">            &#125;,</span><br><span class="line">            &amp;Token::Program&#123; <span class="keyword">ref</span> expressions &#125; =&gt; &#123;</span><br><span class="line">                <span class="keyword">for</span> <span class="variable">expression</span> <span class="keyword">in</span> expressions &#123;</span><br><span class="line">                    <span class="keyword">self</span>.<span class="title function_ invoke__">visit_token</span>(expression);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ol type="1">
<li>A <code>Program</code> consists of <code>Expressions</code>, so we
iterate over each <code>Expression</code>.</li>
<li>For each <code>Expression</code>, visit the <code>left</code>,
<code>right</code> and <code>op</code> side.</li>
<li>When we visit an Integer, pop a free register off to store it</li>
<li>When we visit an AdditionOperator, pop a free register to store the
result</li>
<li>Pop the two most recently added used registers</li>
<li>Generate the IASM</li>
<li>Add the registers previously used to store the left and right values
to the free list</li>
</ol>
<blockquote>
<p>This will not work for more complex expressions, but we’ll deal with
that in a later tutorial.</p>
</blockquote>
<p>Now if we run the test, the output gives us:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[</span><br><span class="line">    &quot;LOAD $0 #1&quot;,</span><br><span class="line">    &quot;LOAD $1 #2&quot;,</span><br><span class="line">    &quot;ADD $1 $0 $2&quot;</span><br><span class="line">]</span><br></pre></td></tr></table></figure>
<p>Even cooler, eh?</p>
<p>Let’s start up the Iridium REPL and input these three lines:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">$ iridium</span><br><span class="line">Welcome to Iridium! Let&#x27;s be productive!</span><br><span class="line">&gt;&gt;&gt; load $0 #1</span><br><span class="line">&gt;&gt;&gt; load $1 #2</span><br><span class="line">&gt;&gt;&gt; add $1 $0 $2</span><br><span class="line">&gt;&gt;&gt; .registers</span><br><span class="line">Listing registers and all contents:</span><br><span class="line">[</span><br><span class="line">    1,</span><br><span class="line">    2,</span><br><span class="line">    3,</span><br><span class="line">    0,</span><br><span class="line">    0,</span><br><span class="line">    &lt;snip&gt;</span><br><span class="line">]</span><br><span class="line">End of Register Listing</span><br></pre></td></tr></table></figure>
<p>Success!</p>
<h2 id="end">End</h2>
<p>Phew, that was a long post. We can make this seamless by adding an
assembler to the <code>Compiler</code> struct, which we’ll do in a later
tutorial. I’m done for now though. =) Palladium is on <a
target="_blank" rel="noopener" href="https://gitlab.com/subnetzero/palladium">GitLab</a></p>
<p>See you next tutorial!</p>
<p>refer to <a
target="_blank" rel="noopener" href="https://blog.subnetzero.io/post/building-language-vm-part-19/">building-language-vm</a></p>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta"><i class="fas fa-circle-user fa-fw"></i>文章作者: </span><span class="post-copyright-info"><a href="https://animenzzzzzz.github.io">Animenzzzzzz</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta"><i class="fas fa-square-arrow-up-right fa-fw"></i>文章链接: </span><span class="post-copyright-info"><a href="https://animenzzzzzz.github.io/pages/build-your-own-vm/19/">https://animenzzzzzz.github.io/pages/build-your-own-vm/19/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta"><i class="fas fa-circle-exclamation fa-fw"></i>版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://animenzzzzzz.github.io" target="_blank">My Dearest</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/virtual-machine/">virtual-machine</a></div><div class="post-share"><div class="social-share" data-image="/img/avatar.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><a class="prev-post pull-left" href="/pages/build-your-own-vm/18/" title="PIDs"><div class="cover" style="background: var(--default-bg-color)"></div><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">PIDs</div></div></a><a class="next-post pull-right" href="/pages/build-your-own-vm/20/" title="Benchmarks"><div class="cover" style="background: var(--default-bg-color)"></div><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">Benchmarks</div></div></a></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class="relatedPosts-list"><a href="/pages/build-your-own-vm/00/" title="Computer Hardware Crash Course"><div class="cover" style="background: var(--default-bg-color)"></div><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2024-11-19</div><div class="title">Computer Hardware Crash Course</div></div></a><a href="/pages/build-your-own-vm/01/" title="Overview and a Simple VM"><div class="cover" style="background: var(--default-bg-color)"></div><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2024-12-20</div><div class="title">Overview and a Simple VM</div></div></a><a href="/pages/build-your-own-vm/03/" title="More Basic Opcodes"><div class="cover" style="background: var(--default-bg-color)"></div><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2024-12-20</div><div class="title">More Basic Opcodes</div></div></a><a href="/pages/build-your-own-vm/02/" title="Basic Opcodes"><div class="cover" style="background: var(--default-bg-color)"></div><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2024-12-20</div><div class="title">Basic Opcodes</div></div></a><a href="/pages/build-your-own-vm/04/" title="Jumps"><div class="cover" style="background: var(--default-bg-color)"></div><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2024-12-24</div><div class="title">Jumps</div></div></a><a href="/pages/build-your-own-vm/05/" title="Equality Checks"><div class="cover" style="background: var(--default-bg-color)"></div><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2024-12-24</div><div class="title">Equality Checks</div></div></a></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info is-center"><div class="avatar-img"><img src="/img/avatar.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info-name">Animenzzzzzz</div><div class="author-info-description">向来如此，便对么？</div><div class="site-data"><a href="/archives/"><div class="headline">文章</div><div class="length-num">69</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">16</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">12</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/Animenzzzzzz"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons"><a class="social-icon" href="https://github.com/Animenzzzzzz" target="_blank" title="Github"><i class="fab fa-github" style="color: #24292e;"></i></a><a class="social-icon" href="mailto:jinnianqianyin@outlook.com" target="_blank" title="Email"><i class="fas fa-envelope" style="color: #4a7dbe;"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>公告</span></div><div class="announcement_content">嘿咻~嘿咻~</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#introduction"><span class="toc-number">1.</span> <span class="toc-text">Introduction</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#flow"><span class="toc-number">2.</span> <span class="toc-text">Flow</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#goals"><span class="toc-number">3.</span> <span class="toc-text">Goals</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#parsers"><span class="toc-number">4.</span> <span class="toc-text">Parsers</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#step-1-new-project"><span class="toc-number">4.1.</span> <span class="toc-text">Step 1: New Project</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#step-2-tokens"><span class="toc-number">4.2.</span> <span class="toc-text">Step 2: Tokens</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#step-3-operator-parsers"><span class="toc-number">4.3.</span> <span class="toc-text">Step 3: Operator Parsers</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#step-4-operand-parsers"><span class="toc-number">4.4.</span> <span class="toc-text">Step 4: Operand Parsers</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#statements-and-expressions"><span class="toc-number">4.5.</span> <span class="toc-text">Statements and Expressions</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#expression"><span class="toc-number">4.5.1.</span> <span class="toc-text">Expression</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#statement"><span class="toc-number">4.5.2.</span> <span class="toc-text">Statement</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#tests"><span class="toc-number">4.5.3.</span> <span class="toc-text">Tests</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#step-5-expression-parser"><span class="toc-number">4.6.</span> <span class="toc-text">Step 5: Expression Parser</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#step-6-program-parser"><span class="toc-number">4.7.</span> <span class="toc-text">Step 6: Program Parser</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#step-7-code-generation"><span class="toc-number">4.8.</span> <span class="toc-text">Step 7: Code Generation!</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#visitor-pattern"><span class="toc-number">4.8.1.</span> <span class="toc-text">Visitor Pattern</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#tests-1"><span class="toc-number">4.8.2.</span> <span class="toc-text">Tests</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#tokenscompile"><span class="toc-number">5.</span> <span class="toc-text">Tokens…​COMPILE!</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#end"><span class="toc-number">6.</span> <span class="toc-text">End</span></a></li></ol></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2024 - 2025 By Animenzzzzzz</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><div class="js-pjax"><script>(() => {
  const runMermaid = (ele) => {
    window.loadMermaid = true
    const theme = document.documentElement.getAttribute('data-theme') === 'dark' ? 'dark' : 'default'

    Array.from(ele).forEach((item, index) => {
      const mermaidSrc = item.firstElementChild
      const mermaidThemeConfig = '%%{init:{ \'theme\':\'' + theme + '\'}}%%\n'
      const mermaidID = 'mermaid-' + index
      const mermaidDefinition = mermaidThemeConfig + mermaidSrc.textContent

      const renderFn = mermaid.render(mermaidID, mermaidDefinition)
      const renderMermaid = svg => {
        mermaidSrc.insertAdjacentHTML('afterend', svg)
      }

      // mermaid v9 and v10 compatibility
      typeof renderFn === 'string' ? renderMermaid(renderFn) : renderFn.then(({svg}) => renderMermaid(svg))
    })
  }

  const codeToMermaid = () => {
    const codeMermaidEle = document.querySelectorAll('pre > code.mermaid')
    if (codeMermaidEle.length === 0) return
    
    codeMermaidEle.forEach(ele => {
      const preEle = document.createElement('pre')
      preEle.className = 'mermaid-src'
      preEle.hidden = true
      preEle.textContent = ele.textContent
      const newEle = document.createElement('div')
      newEle.className = 'mermaid-wrap'
      newEle.appendChild(preEle)
      ele.parentNode.replaceWith(newEle)
    })
  }

  const loadMermaid = () => {
    if (false) codeToMermaid()
    const $mermaid = document.querySelectorAll('#article-container .mermaid-wrap')
    if ($mermaid.length === 0) return

    const runMermaidFn = () => runMermaid($mermaid)
    btf.addGlobalFn('themeChange', runMermaidFn, 'mermaid')
    window.loadMermaid ? runMermaidFn() : btf.getScript('https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js').then(runMermaidFn)
  }
  
  btf.addGlobalFn('encrypt', loadMermaid, 'mermaid')
  window.pjax ? loadMermaid() : document.addEventListener('DOMContentLoaded', loadMermaid)
})()</script></div><script defer="defer" id="ribbon" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/canvas-ribbon.min.js" size="150" alpha="0.6" zIndex="-1" mobile="false" data-click="true"></script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>