<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>Benchmarks | My Dearest</title><meta name="author" content="Animenzzzzzz"><meta name="copyright" content="Animenzzzzzz"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="Doh We’ve been having so much fun, we haven’t written any benchmarks! Though it isn’t the most exciting thing to write, they are important. &#x3D;&#x3D; Benchmarks There’s two things to understand about benc">
<meta property="og:type" content="article">
<meta property="og:title" content="Benchmarks">
<meta property="og:url" content="https://animenzzzzzz.github.io/pages/build-your-own-vm/20/index.html">
<meta property="og:site_name" content="My Dearest">
<meta property="og:description" content="Doh We’ve been having so much fun, we haven’t written any benchmarks! Though it isn’t the most exciting thing to write, they are important. &#x3D;&#x3D; Benchmarks There’s two things to understand about benc">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://animenzzzzzz.github.io/img/avatar.jpg">
<meta property="article:published_time" content="2024-12-31T09:02:25.000Z">
<meta property="article:modified_time" content="2025-01-03T07:36:12.098Z">
<meta property="article:author" content="Animenzzzzzz">
<meta property="article:tag" content="virtual-machine">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://animenzzzzzz.github.io/img/avatar.jpg"><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="https://animenzzzzzz.github.io/pages/build-your-own-vm/20/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css"><script>(()=>{
      const saveToLocal = {
        set: (key, value, ttl) => {
          if (ttl === 0) return
          const now = Date.now()
          const expiry = now + ttl * 86400000
          const item = {
            value,
            expiry
          }
          localStorage.setItem(key, JSON.stringify(item))
        },
      
        get: key => {
          const itemStr = localStorage.getItem(key)
      
          if (!itemStr) {
            return undefined
          }
          const item = JSON.parse(itemStr)
          const now = Date.now()
      
          if (now > item.expiry) {
            localStorage.removeItem(key)
            return undefined
          }
          return item.value
        }
      }
      
      window.btf = {
        saveToLocal: saveToLocal,
        getScript: (url, attr = {}) => new Promise((resolve, reject) => {
          const script = document.createElement('script')
          script.src = url
          script.async = true
          script.onerror = reject
          script.onload = script.onreadystatechange = function() {
            const loadState = this.readyState
            if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
            script.onload = script.onreadystatechange = null
            resolve()
          }

          Object.keys(attr).forEach(key => {
            script.setAttribute(key, attr[key])
          })

          document.head.appendChild(script)
        }),

        getCSS: (url, id = false) => new Promise((resolve, reject) => {
          const link = document.createElement('link')
          link.rel = 'stylesheet'
          link.href = url
          if (id) link.id = id
          link.onerror = reject
          link.onload = link.onreadystatechange = function() {
            const loadState = this.readyState
            if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
            link.onload = link.onreadystatechange = null
            resolve()
          }
          document.head.appendChild(link)
        }),

        addGlobalFn: (key, fn, name = false, parent = window) => {
          const pjaxEnable = false
          if (!pjaxEnable && key.startsWith('pjax')) return

          const globalFn = parent.globalFn || {}
          const keyObj = globalFn[key] || {}
    
          if (name && keyObj[name]) return
    
          name = name || Object.keys(keyObj).length
          keyObj[name] = fn
          globalFn[key] = keyObj
          parent.globalFn = globalFn
        }
      }
    
      const activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      const activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }

      btf.activateDarkMode = activateDarkMode
      btf.activateLightMode = activateLightMode
      
      const t = saveToLocal.get('theme')
    
        if (t === 'dark') activateDarkMode()
        else if (t === 'light') activateLightMode()
      
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
      const detectApple = () => {
        if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
          document.documentElement.classList.add('apple')
        }
      }
      detectApple()
    })()</script><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false,"highlightFullpage":false,"highlightMacStyle":false},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  dateSuffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'null',
  Snackbar: undefined,
  infinitegrid: {
    js: 'https://cdn.jsdelivr.net/npm/@egjs/infinitegrid/dist/infinitegrid.min.js',
    buttonText: '加载更多'
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: false,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'Benchmarks',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2025-01-03 15:36:12'
}</script><link rel="stylesheet" href="/css/font.css"><meta name="generator" content="Hexo 7.3.0"></head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="/img/avatar.jpg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">69</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">16</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">12</div></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url(/img/top_img.jpg);"><nav id="nav"><span id="blog-info"><a href="/" title="My Dearest"><span class="site-name">My Dearest</span></a></span><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div></div><div id="toggle-menu"><span class="site-page"><i class="fas fa-bars fa-fw"></i></span></div></div></nav><div id="post-info"><h1 class="post-title">Benchmarks</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2024-12-31T09:02:25.000Z" title="发表于 2024-12-31 17:02:25">2024-12-31</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2025-01-03T07:36:12.098Z" title="更新于 2025-01-03 15:36:12">2025-01-03</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/Computer/">Computer</a><i class="fas fa-angle-right post-meta-separator"></i><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/Computer/Virtual-Machine/">Virtual Machine</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="Benchmarks"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h2 id="doh">Doh</h2>
<p>We’ve been having so much fun, we haven’t written any benchmarks!
Though it isn’t the most exciting thing to write, they are important. ==
Benchmarks There’s two things to understand about benchmarks:</p>
<ol type="1">
<li>A single benchmark with no context is not helpful</li>
<li>They are most useful when tracked over time</li>
</ol>
<p>Any thing you can benchmark, you can tune to be good at that specific
benchmark.</p>
<h3 id="useful-benchmarks">Useful Benchmarks</h3>
<p>I find benchmarks most helpful when:</p>
<ol type="1">
<li>You collect them from many sub-components of a large system or
application</li>
<li>You keep a historical record, so you can see trends</li>
</ol>
<p>If we are building a system that consists of multiple sub-components
like:</p>
<ul>
<li>Web frontend</li>
<li>Backend</li>
<li>Database</li>
<li>Load Balancers</li>
</ul>
<p>Useful benchmarks for this would be things like:</p>
<ul>
<li>How many concurrent connections can the load balancers sustain on
server type X? I don’t really care how fast it can factor prime
numbers.</li>
<li>How effective is the caching layer of the database server? I don’t
care that its RAM timings are 3ns faster.</li>
</ul>
<p>Anyway, enough rambling. Suffice to say, we should benchmark small
components in isolation and track their performance over time.</p>
<h2 id="adding-in-criterion">Adding in Criterion</h2>
<p>Rust has a benchmarking system, but it isn’t available on stable. The
go-to crate for benchmarking is <a
target="_blank" rel="noopener" href="https://github.com/japaric/criterion.rs">Criterion</a>, so let’s
get going. =)</p>
<h3 id="cargo">Cargo</h3>
<p>Add the following to your Cargo.toml:</p>
<figure class="highlight toml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[[bench]]</span></span><br><span class="line"><span class="attr">name</span> = <span class="string">&quot;iridium&quot;</span></span><br><span class="line"><span class="attr">harness</span> = <span class="literal">false</span></span><br></pre></td></tr></table></figure>
<h3 id="benches">Benches</h3>
<p>Next up, make a new directory at <code>benches/</code>. That’s right,
same level as <code>src/</code>. This file is where we will put our
benchmark functions.</p>
<p>In <code>benches/</code>, create <code>iridium.rs</code> with the
following contents:</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#[macro_use]</span></span><br><span class="line"><span class="keyword">extern</span> <span class="keyword">crate</span> criterion;</span><br><span class="line"><span class="keyword">extern</span> <span class="keyword">crate</span> iridium;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> criterion::Criterion;</span><br><span class="line"><span class="keyword">use</span> iridium::vm::VM;</span><br><span class="line"><span class="keyword">use</span> iridium::assembler::&#123;PIE_HEADER_PREFIX, PIE_HEADER_LENGTH&#125;;</span><br></pre></td></tr></table></figure>
<p>Let’s start with a simple benchmark of the VM executing arithmetic
instructions. Add this next in the <code>iridium.rs</code> file:</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">mod</span> arithmetic &#123;</span><br><span class="line">    <span class="keyword">use</span> super::*;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">execute_add</span>(c: &amp;<span class="keyword">mut</span> Criterion) &#123;</span><br><span class="line">        <span class="keyword">let</span> <span class="variable">clos</span> = &#123;</span><br><span class="line">            <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">test_vm</span> = <span class="title function_ invoke__">get_test_vm</span>();</span><br><span class="line">            test_vm.program = <span class="built_in">vec!</span>[<span class="number">1</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">2</span>];</span><br><span class="line">            test_vm.<span class="title function_ invoke__">run_once</span>();</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        c.<span class="title function_ invoke__">bench_function</span>(</span><br><span class="line">            <span class="string">&quot;execute_add&quot;</span>,</span><br><span class="line">            <span class="keyword">move</span> |b| b.<span class="title function_ invoke__">iter</span>(|| clos )</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>As you can see, it’s almost identical to our test for that:</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#[test]</span></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">test_add_opcode</span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">test_vm</span> = <span class="title function_ invoke__">get_test_vm</span>();</span><br><span class="line">    test_vm.program = <span class="built_in">vec!</span>[<span class="number">1</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">2</span>];</span><br><span class="line">    test_vm.program = <span class="title function_ invoke__">prepend_header</span>(test_vm.program);</span><br><span class="line">    test_vm.<span class="title function_ invoke__">run</span>();</span><br><span class="line">    <span class="built_in">assert_eq!</span>(test_vm.registers[<span class="number">2</span>], <span class="number">15</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>I did not know that we could bind a series of expressions to a
variable! That’s so cool. All we do is replicate the tests for each of
the 4 arithmetic instructions and add them in.</p>
<h3 id="missing-functions">Missing Functions</h3>
<p>You may notice we don’t have the <code>get_test_vm</code> function,
nor do we have the <code>prepend_header</code> function. Since those
have become useful outside of the tests in <code>vm.rs</code>, let’s
move them up to public functions.</p>
<p>Head over to <code>src/vm.rs</code>. We have a bit of re-arranging to
do.</p>
<p>First, let’s move the <code>prepend_header</code> and
<code>get_test_vm</code> functions up to the <code>VM</code> trait and
make them public. This way, we can call them like:
<code>VM::prepend_header(…​)</code>. This will break a few things:</p>
<ol type="1">
<li>Change <code>use assembler::PIE_HEADER_PREFIX;</code> to
<code>use assembler::&#123;PIE_HEADER_PREFIX, PIE_HEADER_LENGTH&#125;;</code></li>
<li>In every test that uses <code>prepend_header</code> or
<code>get_test_vm</code>, preface the function call with VM::. I did
this with a search and replace, but you can use the code in the repo if
you prefer. =)</li>
</ol>
<p>Now back in <code>benches/iridium.rs</code>, we can do:</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">mod</span> arithmetic &#123;</span><br><span class="line">    <span class="keyword">use</span> super::*;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">execute_add</span>(c: &amp;<span class="keyword">mut</span> Criterion) &#123;</span><br><span class="line">        <span class="keyword">let</span> <span class="variable">clos</span> = &#123;</span><br><span class="line">            <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">test_vm</span> = VM::<span class="title function_ invoke__">get_test_vm</span>();</span><br><span class="line">            test_vm.program = <span class="built_in">vec!</span>[<span class="number">1</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">2</span>];</span><br><span class="line">            test_vm.<span class="title function_ invoke__">run_once</span>();</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        c.<span class="title function_ invoke__">bench_function</span>(</span><br><span class="line">            <span class="string">&quot;execute_add&quot;</span>,</span><br><span class="line">            <span class="keyword">move</span> |b| b.<span class="title function_ invoke__">iter</span>(|| clos</span><br><span class="line">            )</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="running-the-benches">Running the Benches</h2>
<p>Almost there! Now we need to use the criterion macros to setup our
benchmark groups. At the end of the arithmetic module, put:</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">criterion_group!&#123;</span><br><span class="line">    name = arithmetic;</span><br><span class="line">    config = Criterion::<span class="title function_ invoke__">default</span>();</span><br><span class="line">    targets = execute_add, execute_sub, execute_mul, execute_div,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Yes, that is supposed to be <code>&#123;</code> and <code>&#125;</code>, not
<code>(</code> and <code>)</code> in the macro. As the final line in the
<code>iridium.rs</code> put:</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">criterion_main!(arithmetic::arithmetic);</span><br></pre></td></tr></table></figure>
<p>And that’s it! Add benchmark functions (or look in the repo) for each
of the arithmetic operators. From the root of the <code>iridium/</code>
directory, we can now run cargo bench and we should see this:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">&lt;snip a lot of stuff before this we don&#x27;t care about&gt;</span><br><span class="line"></span><br><span class="line">Running target/release/deps/iridium-b5264c6303e130cb</span><br><span class="line"></span><br><span class="line">running 0 tests</span><br><span class="line"></span><br><span class="line">test result: ok. 0 passed; 0 failed; 0 ignored; 0 measured; 0 filtered out</span><br><span class="line"></span><br><span class="line">Running target/release/deps/iridium-59eea43f05a081ed</span><br><span class="line">execute_add             time:   [0.0000 ps 0.0000 ps 0.0000 ps]</span><br><span class="line">                   change: [-35.123% +1503.3% +5337.3%] (p = 0.39 &gt; 0.05)</span><br><span class="line">                   No change in performance detected.</span><br><span class="line">Found 13 outliers among 100 measurements (13.00%)</span><br><span class="line">4 (4.00%) high mild</span><br><span class="line">9 (9.00%) high severe</span><br><span class="line"></span><br><span class="line">execute_sub             time:   [0.0000 ps 0.0000 ps 0.0000 ps]</span><br><span class="line">                   change: [-54.712% -12.150% +78.688%] (p = 0.73 &gt; 0.05)</span><br><span class="line">                   No change in performance detected.</span><br><span class="line">Found 13 outliers among 100 measurements (13.00%)</span><br><span class="line">5 (5.00%) high mild</span><br><span class="line">8 (8.00%) high severe</span><br><span class="line"></span><br><span class="line">execute_mul             time:   [0.0000 ps 0.0000 ps 0.0000 ps]</span><br><span class="line">                   change: [-50.926% -1.5089% +101.21%] (p = 0.97 &gt; 0.05)</span><br><span class="line">                   No change in performance detected.</span><br><span class="line">Found 12 outliers among 100 measurements (12.00%)</span><br><span class="line">4 (4.00%) high mild</span><br><span class="line">8 (8.00%) high severe</span><br><span class="line"></span><br><span class="line">execute_div             time:   [0.0000 ps 0.0000 ps 0.0000 ps]</span><br><span class="line">                   change: [-48.559% -5.5472% +73.134%] (p = 0.87 &gt; 0.05)</span><br><span class="line">                   No change in performance detected.</span><br><span class="line">Found 11 outliers among 100 measurements (11.00%)</span><br><span class="line">3 (3.00%) high mild</span><br><span class="line">8 (8.00%) high severe</span><br></pre></td></tr></table></figure>
<p>If you look in <code>targets/criterion/</code> you will see nice
graphs that criterion output.</p>
<h2 id="keeping-the-benchmark-graphs">Keeping the Benchmark Graphs</h2>
<p>If we want to keep these graphs so we can compare runs over time, we
need to put them somewhere. Since we use Appveyor, Gitlab, and Travis to
build Iridium for multiple platforms, and each of those platforms will
have benchmarks run, we need to keep them. The easiest thing to do is to
specify that they are artifacts and keep them from each build, along
with the binary, for each platform.</p>
<p>I won’t go through all that here, but you can check out the
<code>.travis.yml</code>, <code>.gitlab-ci.yml</code> and
<code>appveyor.ym</code>l to see how I did it.</p>
<h2 id="end">End</h2>
<p>I think that is a good stopping point. There’s TONS more benchmarks
we need to write, and we’ll add more in as we go.</p>
<p>See you next time!</p>
<p>refer to <a
target="_blank" rel="noopener" href="https://blog.subnetzero.io/post/building-language-vm-part-20/">building-language-vm</a></p>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta"><i class="fas fa-circle-user fa-fw"></i>文章作者: </span><span class="post-copyright-info"><a href="https://animenzzzzzz.github.io">Animenzzzzzz</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta"><i class="fas fa-square-arrow-up-right fa-fw"></i>文章链接: </span><span class="post-copyright-info"><a href="https://animenzzzzzz.github.io/pages/build-your-own-vm/20/">https://animenzzzzzz.github.io/pages/build-your-own-vm/20/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta"><i class="fas fa-circle-exclamation fa-fw"></i>版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://animenzzzzzz.github.io" target="_blank">My Dearest</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/virtual-machine/">virtual-machine</a></div><div class="post-share"><div class="social-share" data-image="/img/avatar.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><a class="prev-post pull-left" href="/pages/build-your-own-vm/19/" title="Starting on Palladium"><div class="cover" style="background: var(--default-bg-color)"></div><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">Starting on Palladium</div></div></a><a class="next-post pull-right" href="/pages/build-your-own-vm/21/" title="Header Offset"><div class="cover" style="background: var(--default-bg-color)"></div><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">Header Offset</div></div></a></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class="relatedPosts-list"><a href="/pages/build-your-own-vm/00/" title="Computer Hardware Crash Course"><div class="cover" style="background: var(--default-bg-color)"></div><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2024-11-19</div><div class="title">Computer Hardware Crash Course</div></div></a><a href="/pages/build-your-own-vm/01/" title="Overview and a Simple VM"><div class="cover" style="background: var(--default-bg-color)"></div><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2024-12-20</div><div class="title">Overview and a Simple VM</div></div></a><a href="/pages/build-your-own-vm/03/" title="More Basic Opcodes"><div class="cover" style="background: var(--default-bg-color)"></div><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2024-12-20</div><div class="title">More Basic Opcodes</div></div></a><a href="/pages/build-your-own-vm/02/" title="Basic Opcodes"><div class="cover" style="background: var(--default-bg-color)"></div><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2024-12-20</div><div class="title">Basic Opcodes</div></div></a><a href="/pages/build-your-own-vm/04/" title="Jumps"><div class="cover" style="background: var(--default-bg-color)"></div><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2024-12-24</div><div class="title">Jumps</div></div></a><a href="/pages/build-your-own-vm/05/" title="Equality Checks"><div class="cover" style="background: var(--default-bg-color)"></div><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2024-12-24</div><div class="title">Equality Checks</div></div></a></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info is-center"><div class="avatar-img"><img src="/img/avatar.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info-name">Animenzzzzzz</div><div class="author-info-description">向来如此，便对么？</div><div class="site-data"><a href="/archives/"><div class="headline">文章</div><div class="length-num">69</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">16</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">12</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/Animenzzzzzz"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons"><a class="social-icon" href="https://github.com/Animenzzzzzz" target="_blank" title="Github"><i class="fab fa-github" style="color: #24292e;"></i></a><a class="social-icon" href="mailto:jinnianqianyin@outlook.com" target="_blank" title="Email"><i class="fas fa-envelope" style="color: #4a7dbe;"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>公告</span></div><div class="announcement_content">嘿咻~嘿咻~</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#doh"><span class="toc-number">1.</span> <span class="toc-text">Doh</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#useful-benchmarks"><span class="toc-number">1.1.</span> <span class="toc-text">Useful Benchmarks</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#adding-in-criterion"><span class="toc-number">2.</span> <span class="toc-text">Adding in Criterion</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#cargo"><span class="toc-number">2.1.</span> <span class="toc-text">Cargo</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#benches"><span class="toc-number">2.2.</span> <span class="toc-text">Benches</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#missing-functions"><span class="toc-number">2.3.</span> <span class="toc-text">Missing Functions</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#running-the-benches"><span class="toc-number">3.</span> <span class="toc-text">Running the Benches</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#keeping-the-benchmark-graphs"><span class="toc-number">4.</span> <span class="toc-text">Keeping the Benchmark Graphs</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#end"><span class="toc-number">5.</span> <span class="toc-text">End</span></a></li></ol></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2024 - 2025 By Animenzzzzzz</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><div class="js-pjax"><script>(() => {
  const runMermaid = (ele) => {
    window.loadMermaid = true
    const theme = document.documentElement.getAttribute('data-theme') === 'dark' ? 'dark' : 'default'

    Array.from(ele).forEach((item, index) => {
      const mermaidSrc = item.firstElementChild
      const mermaidThemeConfig = '%%{init:{ \'theme\':\'' + theme + '\'}}%%\n'
      const mermaidID = 'mermaid-' + index
      const mermaidDefinition = mermaidThemeConfig + mermaidSrc.textContent

      const renderFn = mermaid.render(mermaidID, mermaidDefinition)
      const renderMermaid = svg => {
        mermaidSrc.insertAdjacentHTML('afterend', svg)
      }

      // mermaid v9 and v10 compatibility
      typeof renderFn === 'string' ? renderMermaid(renderFn) : renderFn.then(({svg}) => renderMermaid(svg))
    })
  }

  const codeToMermaid = () => {
    const codeMermaidEle = document.querySelectorAll('pre > code.mermaid')
    if (codeMermaidEle.length === 0) return
    
    codeMermaidEle.forEach(ele => {
      const preEle = document.createElement('pre')
      preEle.className = 'mermaid-src'
      preEle.hidden = true
      preEle.textContent = ele.textContent
      const newEle = document.createElement('div')
      newEle.className = 'mermaid-wrap'
      newEle.appendChild(preEle)
      ele.parentNode.replaceWith(newEle)
    })
  }

  const loadMermaid = () => {
    if (false) codeToMermaid()
    const $mermaid = document.querySelectorAll('#article-container .mermaid-wrap')
    if ($mermaid.length === 0) return

    const runMermaidFn = () => runMermaid($mermaid)
    btf.addGlobalFn('themeChange', runMermaidFn, 'mermaid')
    window.loadMermaid ? runMermaidFn() : btf.getScript('https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js').then(runMermaidFn)
  }
  
  btf.addGlobalFn('encrypt', loadMermaid, 'mermaid')
  window.pjax ? loadMermaid() : document.addEventListener('DOMContentLoaded', loadMermaid)
})()</script></div><script defer="defer" id="ribbon" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/canvas-ribbon.min.js" size="150" alpha="0.6" zIndex="-1" mobile="false" data-click="true"></script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>