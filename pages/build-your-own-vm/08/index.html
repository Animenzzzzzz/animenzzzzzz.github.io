<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>Assembler-The Beginning | My Dearest</title><meta name="author" content="Animenzzzzzz"><meta name="copyright" content="Animenzzzzzz"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="Instructions Assemble! We could torture ourselves by writing all our programs in hex, and if that&#39;s your thing, this section is technically optional. LOAD $1 #10 into: 00 01 00 0A It also has a">
<meta property="og:type" content="article">
<meta property="og:title" content="Assembler-The Beginning">
<meta property="og:url" content="https://animenzzzzzz.github.io/pages/build-your-own-vm/08/index.html">
<meta property="og:site_name" content="My Dearest">
<meta property="og:description" content="Instructions Assemble! We could torture ourselves by writing all our programs in hex, and if that&#39;s your thing, this section is technically optional. LOAD $1 #10 into: 00 01 00 0A It also has a">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://animenzzzzzz.github.io/img/avatar.jpg">
<meta property="article:published_time" content="2024-12-24T06:40:20.000Z">
<meta property="article:modified_time" content="2025-01-03T07:34:37.612Z">
<meta property="article:author" content="Animenzzzzzz">
<meta property="article:tag" content="virtual-machine">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://animenzzzzzz.github.io/img/avatar.jpg"><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="https://animenzzzzzz.github.io/pages/build-your-own-vm/08/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css"><script>(()=>{
      const saveToLocal = {
        set: (key, value, ttl) => {
          if (ttl === 0) return
          const now = Date.now()
          const expiry = now + ttl * 86400000
          const item = {
            value,
            expiry
          }
          localStorage.setItem(key, JSON.stringify(item))
        },
      
        get: key => {
          const itemStr = localStorage.getItem(key)
      
          if (!itemStr) {
            return undefined
          }
          const item = JSON.parse(itemStr)
          const now = Date.now()
      
          if (now > item.expiry) {
            localStorage.removeItem(key)
            return undefined
          }
          return item.value
        }
      }
      
      window.btf = {
        saveToLocal: saveToLocal,
        getScript: (url, attr = {}) => new Promise((resolve, reject) => {
          const script = document.createElement('script')
          script.src = url
          script.async = true
          script.onerror = reject
          script.onload = script.onreadystatechange = function() {
            const loadState = this.readyState
            if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
            script.onload = script.onreadystatechange = null
            resolve()
          }

          Object.keys(attr).forEach(key => {
            script.setAttribute(key, attr[key])
          })

          document.head.appendChild(script)
        }),

        getCSS: (url, id = false) => new Promise((resolve, reject) => {
          const link = document.createElement('link')
          link.rel = 'stylesheet'
          link.href = url
          if (id) link.id = id
          link.onerror = reject
          link.onload = link.onreadystatechange = function() {
            const loadState = this.readyState
            if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
            link.onload = link.onreadystatechange = null
            resolve()
          }
          document.head.appendChild(link)
        }),

        addGlobalFn: (key, fn, name = false, parent = window) => {
          const pjaxEnable = false
          if (!pjaxEnable && key.startsWith('pjax')) return

          const globalFn = parent.globalFn || {}
          const keyObj = globalFn[key] || {}
    
          if (name && keyObj[name]) return
    
          name = name || Object.keys(keyObj).length
          keyObj[name] = fn
          globalFn[key] = keyObj
          parent.globalFn = globalFn
        }
      }
    
      const activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      const activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }

      btf.activateDarkMode = activateDarkMode
      btf.activateLightMode = activateLightMode
      
      const t = saveToLocal.get('theme')
    
        if (t === 'dark') activateDarkMode()
        else if (t === 'light') activateLightMode()
      
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
      const detectApple = () => {
        if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
          document.documentElement.classList.add('apple')
        }
      }
      detectApple()
    })()</script><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false,"highlightFullpage":false,"highlightMacStyle":false},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  dateSuffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'null',
  Snackbar: undefined,
  infinitegrid: {
    js: 'https://cdn.jsdelivr.net/npm/@egjs/infinitegrid/dist/infinitegrid.min.js',
    buttonText: '加载更多'
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: false,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'Assembler-The Beginning',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2025-01-03 15:34:37'
}</script><link rel="stylesheet" href="/css/font.css"><meta name="generator" content="Hexo 7.3.0"></head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="/img/avatar.jpg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">69</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">16</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">12</div></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url(/img/top_img.jpg);"><nav id="nav"><span id="blog-info"><a href="/" title="My Dearest"><span class="site-name">My Dearest</span></a></span><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div></div><div id="toggle-menu"><span class="site-page"><i class="fas fa-bars fa-fw"></i></span></div></div></nav><div id="post-info"><h1 class="post-title">Assembler-The Beginning</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2024-12-24T06:40:20.000Z" title="发表于 2024-12-24 14:40:20">2024-12-24</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2025-01-03T07:34:37.612Z" title="更新于 2025-01-03 15:34:37">2025-01-03</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/Computer/">Computer</a><i class="fas fa-angle-right post-meta-separator"></i><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/Computer/Virtual-Machine/">Virtual Machine</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="Assembler-The Beginning"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h2 id="instructions-assemble">Instructions Assemble!</h2>
<p>We could torture ourselves by writing all our programs in hex, and if
that's your thing, this section is technically optional.</p>
<p><code>LOAD $1 #10</code></p>
<p>into:</p>
<p><code>00 01 00 0A</code></p>
<p>It also has a few other responsibilities:</p>
<ol type="1">
<li>Handling labels</li>
<li>Calculating constants</li>
</ol>
<h2 id="lexing">Lexing</h2>
<p>A Lexer is a program that takes in a stream of text, checks it
against a bunch of rules, and emits a stream of tokens.</p>
<h2 id="lexemes-and-tokens">Lexemes and Tokens</h2>
<p>Lexing produces lexemes, which are something like "units of meaning"
in a sentence. In our example <code>LOAD $1 #10</code>, the lexemes
would be: <code>LOAD, $, 1, #, 1, 0</code>.</p>
<p>These lexemes are combined with an id or name into a
<code>token</code>. So in our example, our tokens are:
<code>&lt;opcode, 0&gt;</code>, <code>&lt;register, 1&gt;</code>,
<code>&lt;number, 10&gt;</code></p>
<h2 id="grammar">Grammar</h2>
<p>So let’s define some things about our assembly language:</p>
<ol type="1">
<li>A <code>Program</code> is composed of <code>Instructions</code></li>
<li>An <code>Instruction</code> is composed of:
<ul>
<li>An <code>Opcode</code></li>
<li>A <code>Register</code></li>
<li>A <code>IntegerOperand</code></li>
<li>A <code>Newline</code></li>
</ul></li>
<li>An <code>Opcode</code> is composed of:
<ul>
<li>One or more <code>Letters</code> in a row</li>
<li>A <code>Space</code></li>
</ul></li>
<li>A <code>Register</code> is composed of:
<ul>
<li>The symbol <code>$</code></li>
<li>A <code>Number</code></li>
<li>A <code>Space</code></li>
</ul></li>
<li>A <code>IntegerOperand</code> is composed of:
<ul>
<li>The symbol <code>#</code></li>
<li>A <code>Number</code></li>
</ul></li>
<li>A <code>Number</code> is composed of:
<ul>
<li>The symbols <code>0-9</code></li>
</ul></li>
<li>A <code>Newline</code> is composed of:
<ul>
<li>The symbol <code>\n</code></li>
</ul></li>
</ol>
<p>This is called a <em>grammar</em>. It has the rules of our language
so far, and we'll expand it as we go through this section.</p>
<blockquote>
<p>To delve further into lexing and grammars, google context free
grammars and backus-naur form.</p>
</blockquote>
<h2 id="back-to-lexing">Back to Lexing</h2>
<p>So how do we get a lexer?</p>
<p>Two options:</p>
<ol type="1">
<li>We could write our own Lexer. This is not super difficult, and
everyone should do it at least once.</li>
<li>We could use a tool like <code>lex</code>.</li>
</ol>
<p>I gave serious consideration to writing our own, but I want the focus
of these tutorials to be the VM. There's a ton of tutorials on writing
lexers, and I might add one at a later date. For now, we're going to use
the Rust tool: <code>Nom</code>. This tool makes it very, very easy to
handle our lexing and parsing needs.</p>
<h2 id="omnomnomnomnom">Omnomnomnomnom</h2>
<p>To start gobbling bits, we have to do the following:</p>
<ol type="1">
<li>Add <code>nom</code> as a dependency</li>
<li>Add the <code>nom</code> crate to <code>main.rs</code></li>
<li>Create a module directory for the assembler</li>
<li>Add the assembler module to <code>main.rs</code></li>
<li>Create a Token enum</li>
<li>Create rules for <code>nom</code></li>
</ol>
<h2 id="nom-dependency">Nom Dependency</h2>
<p>In your <code>Cargo.toml</code> file, add nom as a dependency:</p>
<figure class="highlight toml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[dependencies]</span></span><br><span class="line"><span class="attr">nom</span> = <span class="string">&quot;^4.0&quot;</span></span><br></pre></td></tr></table></figure>
<h2 id="files">Files</h2>
<ol type="1">
<li>Create a new directory under <code>src</code> called
<code>assembler</code>, and add a <code>mod.rs</code> file to it</li>
<li>In <code>main.rs</code>, add <code>pub mod assembler</code>; to the
top</li>
<li>In <code>main.rs</code>, add <code>#[macro_use]</code> to the top
<ul>
<li>In <code>main.rs</code> add <code>extern crate nom</code>; on the
line below</li>
</ul></li>
<li>Create <code>opcode.rs</code> in <code>src/assembler</code></li>
</ol>
<h2 id="token-enum">Token Enum</h2>
<p><code>nom</code> needs something to emit, so we need to create a
Token enum. In <code>src/assembler/mod.rs</code>, put:</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> instruction::Opcode;</span><br><span class="line"></span><br><span class="line"><span class="meta">#[derive(Debug, PartialEq)]</span></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">enum</span> <span class="title class_">Token</span> &#123;</span><br><span class="line">    Op&#123;code: Opcode&#125;,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Right now, we're only going to teach our parser to recognize an
Opcode. Whenever it finds one, it will create
<code>Token::Op&#123;code: Opcode&#125;</code>.</p>
<h2 id="rules-the-basics">Rules: The Basics</h2>
<p>OK, time to write our first rule. I'll try to explain enough about
nom as we go, but for a deep-dive into it, peruse their GitHub. The
basic idea is that we are going to use nom’s macros to write a bunch of
rules that, when applied, can parse a file containing valid iridium
assembler code. These parsers can build on each other; this permits
creating complex rules composed of simpler rules. We’ll see how this is
useful in a bit.</p>
<h3 id="rules-opcode">Rules: Opcode</h3>
<p>Earlier in the post, we defined an Opcode as:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">. An `Opcode` is composed of:</span><br><span class="line">  * One or more `Letters` in a row</span><br><span class="line">  * A `Space`</span><br></pre></td></tr></table></figure>
<p>Let's take this one line at a time. In
<code>src/assembler/opcode_parsers.rs</code>:</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> nom::types::CompleteStr;</span><br></pre></td></tr></table></figure>
<p>This loads in the <code>nom</code> type <code>CompleteStr</code>.
We'll be passing complete strings to our rules, not streaming data. This
uses the <code>named!</code> macro in the nom crate to define a function
called <code>opcode_load</code>. It will take a <code>CompleteStr</code>
and return a <code>Token</code>.</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">named!(opcode_load&lt;CompleteStr, Token&gt;,</span><br><span class="line">  do_parse!(</span><br><span class="line">      tag!(<span class="string">&quot;load&quot;</span>) &gt;&gt; (Token::Op&#123;code: Opcode::LOAD&#125;)</span><br><span class="line">  )</span><br><span class="line">);</span><br></pre></td></tr></table></figure>
<p>The critical part here is
<code>tag!("load") &gt;&gt; (Token::Op&#123;code: Opcode::LOAD&#125;)</code>. It
looks for the string "load" in the string we give it, and if it finds
it, it returns an enum.</p>
<h3 id="tests">Tests</h3>
<p>Time to write a test for our parser! In
<code>opcode_parsers.rs</code>, put:</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#[cfg(test)]</span></span><br><span class="line"><span class="keyword">mod</span> tests &#123;</span><br><span class="line">    <span class="keyword">use</span> super::*;</span><br><span class="line"></span><br><span class="line">    <span class="meta">#[test]</span></span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">test_opcode_load</span>() &#123;</span><br><span class="line">        <span class="comment">// First tests that the opcode is detected and parsed correctly</span></span><br><span class="line">        <span class="keyword">let</span> <span class="variable">result</span> = <span class="title function_ invoke__">opcode_load</span>(<span class="title function_ invoke__">CompleteStr</span>(<span class="string">&quot;load&quot;</span>));</span><br><span class="line">        <span class="built_in">assert_eq!</span>(result.<span class="title function_ invoke__">is_ok</span>(), <span class="literal">true</span>);</span><br><span class="line">        <span class="keyword">let</span> (rest, token) = result.<span class="title function_ invoke__">unwrap</span>();</span><br><span class="line">        <span class="built_in">assert_eq!</span>(token, Token::Op&#123;code: Opcode::LOAD&#125;);</span><br><span class="line">        <span class="built_in">assert_eq!</span>(rest, <span class="title function_ invoke__">CompleteStr</span>(<span class="string">&quot;&quot;</span>));</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Tests that an invalid opcode isn&#x27;t recognized</span></span><br><span class="line">        <span class="keyword">let</span> <span class="variable">result</span> = <span class="title function_ invoke__">opcode_load</span>(<span class="title function_ invoke__">CompleteStr</span>(<span class="string">&quot;aold&quot;</span>));</span><br><span class="line">        <span class="built_in">assert_eq!</span>(result.<span class="title function_ invoke__">is_ok</span>(), <span class="literal">false</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="rules-registers">Rules: Registers</h3>
<p>Now on to registers. First, let's create the Register variant of our
Token enum in <code>src/assembler/mod.rs</code>:</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#[derive(Debug, PartialEq)]</span></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">enum</span> <span class="title class_">Token</span> &#123;</span><br><span class="line">    Op&#123;code: Opcode&#125;,</span><br><span class="line">    Register&#123;reg_num: <span class="type">u8</span>&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Next, a parser for a register. We'll put this in
<code>src/assembler/register_parsers.rs</code>. In our assembly
language, they take the form of <code>$0</code>; a dollar sign followed
by a number &gt;= 0. Our function for this looks like:</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> nom::types::CompleteStr;</span><br><span class="line"><span class="keyword">use</span> nom::digit;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> assembler::Token;</span><br><span class="line"></span><br><span class="line">named!(register &lt;CompleteStr, Token&gt;,                     <span class="comment">// &lt;1&gt;</span></span><br><span class="line">    ws!(                                                  <span class="comment">// &lt;2&gt;</span></span><br><span class="line">        do_parse!(                                        <span class="comment">// &lt;3&gt;</span></span><br><span class="line">            tag!(<span class="string">&quot;$&quot;</span>) &gt;&gt;                                  <span class="comment">// &lt;4&gt;</span></span><br><span class="line">            reg_num: digit &gt;&gt;                             <span class="comment">// &lt;5&gt;</span></span><br><span class="line">            (                                             <span class="comment">// &lt;6&gt;</span></span><br><span class="line">                Token::Register&#123;                          <span class="comment">// &lt;7&gt;</span></span><br><span class="line">                  reg_num: reg_num.parse::&lt;<span class="type">u8</span>&gt;().<span class="title function_ invoke__">unwrap</span>() <span class="comment">// &lt;8&gt;</span></span><br><span class="line">                &#125;                                         <span class="comment">// &lt;9&gt;</span></span><br><span class="line">            )                                             <span class="comment">// &lt;10&gt;</span></span><br><span class="line">        )</span><br><span class="line">    )</span><br><span class="line">);</span><br></pre></td></tr></table></figure>
<ol type="1">
<li>We create a function named <code>register</code> that accepts a
CompleteStr and returns a <code>CompleteStr</code> and
<code>Token</code> or an <code>Error</code></li>
<li>We use the <code>ws!</code> macro, which tells it to consume any
whitespace on either side of our register. This lets us write variants
such as <code>LOAD $0</code> in addition to <code>LOAD $0</code></li>
<li>We use the <code>do_parse!</code> macro to chain parsers</li>
<li>to the function <code>digit</code>, and save the result in a
variable called reg_num. nom provides the function digit, which
recognizes one or more 0-9 characters</li>
<li>Create the <code>Token</code> enum with the appropriate info and
return</li>
<li>Start creation of the <code>Token</code>. We want the
<code>Register</code> variant</li>
<li>Attempt to unwrap and store the result of parsing the digits into a
<code>u8</code></li>
<li>Close the <code>Token</code> struct</li>
</ol>
<h3 id="tests-1">Tests</h3>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#[test]</span></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">test_parse_register</span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">result</span> = <span class="title function_ invoke__">register</span>(<span class="title function_ invoke__">CompleteStr</span>(<span class="string">&quot;$0&quot;</span>));</span><br><span class="line">    <span class="built_in">assert_eq!</span>(result.<span class="title function_ invoke__">is_ok</span>(), <span class="literal">true</span>);</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">result</span> = <span class="title function_ invoke__">register</span>(<span class="title function_ invoke__">CompleteStr</span>(<span class="string">&quot;0&quot;</span>));</span><br><span class="line">    <span class="built_in">assert_eq!</span>(result.<span class="title function_ invoke__">is_ok</span>(), <span class="literal">false</span>);</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">result</span> = <span class="title function_ invoke__">register</span>(<span class="title function_ invoke__">CompleteStr</span>(<span class="string">&quot;$a&quot;</span>));</span><br><span class="line">    <span class="built_in">assert_eq!</span>(result.<span class="title function_ invoke__">is_ok</span>(), <span class="literal">false</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>You could add even more error cases, such as "$", depending on how
test-happy you are.</p>
<h3 id="rules-integer-operands">Rules: Integer Operands</h3>
<p>And finally, integer operands! Create the <code>IntegerOperand</code>
variant of our <code>Token</code> enum in
<code>src/assembler/mod.rs</code>:</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#[derive(Debug, PartialEq)]</span></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">enum</span> <span class="title class_">Token</span> &#123;</span><br><span class="line">    Op&#123;code: Opcode&#125;,</span><br><span class="line">    Register&#123;reg_num: <span class="type">u8</span>&#125;,</span><br><span class="line">    IntegerOperand&#123;value: <span class="type">i32</span>&#125;,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>Yes, we are technically allowing the user to input negative numbers
here, since we parse it into an i32. Our LOAD instruction can only load
16 bits, though. This is for future expansion.</p>
</blockquote>
<p>Next, make the file <code>src/assembler/operand_parsers.rs</code>, in
which we'll put the last parser we have to write: one to recognize an
<code>IntegerOperand</code>. We said those are composed of
<code>#</code> followed by digits. In <code>operand_parsers.rs</code>,
put:</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> nom::types::CompleteStr;</span><br><span class="line"><span class="keyword">use</span> nom::digit;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> assembler::Token;</span><br><span class="line"></span><br><span class="line"><span class="comment">/// Parser for integer numbers, which we preface with `#` in our assembly language:</span></span><br><span class="line"><span class="comment">/// #100</span></span><br><span class="line">named!(integer_operand&lt;CompleteStr, Token&gt;,</span><br><span class="line">    ws!(</span><br><span class="line">        do_parse!(</span><br><span class="line">            tag!(<span class="string">&quot;#&quot;</span>) &gt;&gt;</span><br><span class="line">            reg_num: digit &gt;&gt;</span><br><span class="line">            (</span><br><span class="line">                Token::IntegerOperand&#123;value: reg_num.parse::&lt;<span class="type">i32</span>&gt;().<span class="title function_ invoke__">unwrap</span>()&#125;</span><br><span class="line">            )</span><br><span class="line">        )</span><br><span class="line">    )</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="meta">#[test]</span></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">test_parse_integer_operand</span>() &#123;</span><br><span class="line">    <span class="comment">// Test a valid integer operand</span></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">result</span> = <span class="title function_ invoke__">integer_operand</span>(<span class="title function_ invoke__">CompleteStr</span>(<span class="string">&quot;#10&quot;</span>));</span><br><span class="line">    <span class="built_in">assert_eq!</span>(result.<span class="title function_ invoke__">is_ok</span>(), <span class="literal">true</span>);</span><br><span class="line">    <span class="keyword">let</span> (rest, value) = result.<span class="title function_ invoke__">unwrap</span>();</span><br><span class="line">    <span class="built_in">assert_eq!</span>(rest, <span class="title function_ invoke__">CompleteStr</span>(<span class="string">&quot;&quot;</span>));</span><br><span class="line">    <span class="built_in">assert_eq!</span>(value, Token::IntegerOperand&#123;value: <span class="number">10</span>&#125;);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Test an invalid one (missing the #)</span></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">result</span> = <span class="title function_ invoke__">integer_operand</span>(<span class="title function_ invoke__">CompleteStr</span>(<span class="string">&quot;10&quot;</span>));</span><br><span class="line">    <span class="built_in">assert_eq!</span>(result.<span class="title function_ invoke__">is_ok</span>(), <span class="literal">false</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="wrapping-it-up-in-mod.rs">Wrapping it up in mod.rs</h3>
<p>Now in <code>src/assembler/mod.rs</code>, export the three modules we
made by adding:</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">pub</span> <span class="keyword">mod</span> opcode_parsers;</span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">mod</span> operand_parsers;</span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">mod</span> register_parsers;</span><br></pre></td></tr></table></figure>
<p>to the top.</p>
<h2 id="end">End</h2>
<p>Phew, this was a longer post, so I'm going to stop here. Next, we'll
go over how to combine these parsers into ones that can parse entire
instructions, and ultimately entire programs.</p>
<p>refer to <a
target="_blank" rel="noopener" href="https://blog.subnetzero.io/post/building-language-vm-part-08/">building-language-vm</a></p>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta"><i class="fas fa-circle-user fa-fw"></i>文章作者: </span><span class="post-copyright-info"><a href="https://animenzzzzzz.github.io">Animenzzzzzz</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta"><i class="fas fa-square-arrow-up-right fa-fw"></i>文章链接: </span><span class="post-copyright-info"><a href="https://animenzzzzzz.github.io/pages/build-your-own-vm/08/">https://animenzzzzzz.github.io/pages/build-your-own-vm/08/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta"><i class="fas fa-circle-exclamation fa-fw"></i>版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://animenzzzzzz.github.io" target="_blank">My Dearest</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/virtual-machine/">virtual-machine</a></div><div class="post-share"><div class="social-share" data-image="/img/avatar.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><a class="prev-post pull-left" href="/pages/build-your-own-vm/07/" title="REPL and Code Execution"><div class="cover" style="background: var(--default-bg-color)"></div><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">REPL and Code Execution</div></div></a><a class="next-post pull-right" href="/pages/build-your-own-vm/09/" title="Assembler-Cruise Control"><div class="cover" style="background: var(--default-bg-color)"></div><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">Assembler-Cruise Control</div></div></a></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class="relatedPosts-list"><a href="/pages/build-your-own-vm/00/" title="Computer Hardware Crash Course"><div class="cover" style="background: var(--default-bg-color)"></div><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2024-11-19</div><div class="title">Computer Hardware Crash Course</div></div></a><a href="/pages/build-your-own-vm/01/" title="Overview and a Simple VM"><div class="cover" style="background: var(--default-bg-color)"></div><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2024-12-20</div><div class="title">Overview and a Simple VM</div></div></a><a href="/pages/build-your-own-vm/03/" title="More Basic Opcodes"><div class="cover" style="background: var(--default-bg-color)"></div><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2024-12-20</div><div class="title">More Basic Opcodes</div></div></a><a href="/pages/build-your-own-vm/02/" title="Basic Opcodes"><div class="cover" style="background: var(--default-bg-color)"></div><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2024-12-20</div><div class="title">Basic Opcodes</div></div></a><a href="/pages/build-your-own-vm/04/" title="Jumps"><div class="cover" style="background: var(--default-bg-color)"></div><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2024-12-24</div><div class="title">Jumps</div></div></a><a href="/pages/build-your-own-vm/05/" title="Equality Checks"><div class="cover" style="background: var(--default-bg-color)"></div><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2024-12-24</div><div class="title">Equality Checks</div></div></a></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info is-center"><div class="avatar-img"><img src="/img/avatar.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info-name">Animenzzzzzz</div><div class="author-info-description">向来如此，便对么？</div><div class="site-data"><a href="/archives/"><div class="headline">文章</div><div class="length-num">69</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">16</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">12</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/Animenzzzzzz"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons"><a class="social-icon" href="https://github.com/Animenzzzzzz" target="_blank" title="Github"><i class="fab fa-github" style="color: #24292e;"></i></a><a class="social-icon" href="mailto:jinnianqianyin@outlook.com" target="_blank" title="Email"><i class="fas fa-envelope" style="color: #4a7dbe;"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>公告</span></div><div class="announcement_content">嘿咻~嘿咻~</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#instructions-assemble"><span class="toc-number">1.</span> <span class="toc-text">Instructions Assemble!</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#lexing"><span class="toc-number">2.</span> <span class="toc-text">Lexing</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#lexemes-and-tokens"><span class="toc-number">3.</span> <span class="toc-text">Lexemes and Tokens</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#grammar"><span class="toc-number">4.</span> <span class="toc-text">Grammar</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#back-to-lexing"><span class="toc-number">5.</span> <span class="toc-text">Back to Lexing</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#omnomnomnomnom"><span class="toc-number">6.</span> <span class="toc-text">Omnomnomnomnom</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#nom-dependency"><span class="toc-number">7.</span> <span class="toc-text">Nom Dependency</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#files"><span class="toc-number">8.</span> <span class="toc-text">Files</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#token-enum"><span class="toc-number">9.</span> <span class="toc-text">Token Enum</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#rules-the-basics"><span class="toc-number">10.</span> <span class="toc-text">Rules: The Basics</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#rules-opcode"><span class="toc-number">10.1.</span> <span class="toc-text">Rules: Opcode</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#tests"><span class="toc-number">10.2.</span> <span class="toc-text">Tests</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#rules-registers"><span class="toc-number">10.3.</span> <span class="toc-text">Rules: Registers</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#tests-1"><span class="toc-number">10.4.</span> <span class="toc-text">Tests</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#rules-integer-operands"><span class="toc-number">10.5.</span> <span class="toc-text">Rules: Integer Operands</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#wrapping-it-up-in-mod.rs"><span class="toc-number">10.6.</span> <span class="toc-text">Wrapping it up in mod.rs</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#end"><span class="toc-number">11.</span> <span class="toc-text">End</span></a></li></ol></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2024 - 2025 By Animenzzzzzz</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><div class="js-pjax"><script>(() => {
  const runMermaid = (ele) => {
    window.loadMermaid = true
    const theme = document.documentElement.getAttribute('data-theme') === 'dark' ? 'dark' : 'default'

    Array.from(ele).forEach((item, index) => {
      const mermaidSrc = item.firstElementChild
      const mermaidThemeConfig = '%%{init:{ \'theme\':\'' + theme + '\'}}%%\n'
      const mermaidID = 'mermaid-' + index
      const mermaidDefinition = mermaidThemeConfig + mermaidSrc.textContent

      const renderFn = mermaid.render(mermaidID, mermaidDefinition)
      const renderMermaid = svg => {
        mermaidSrc.insertAdjacentHTML('afterend', svg)
      }

      // mermaid v9 and v10 compatibility
      typeof renderFn === 'string' ? renderMermaid(renderFn) : renderFn.then(({svg}) => renderMermaid(svg))
    })
  }

  const codeToMermaid = () => {
    const codeMermaidEle = document.querySelectorAll('pre > code.mermaid')
    if (codeMermaidEle.length === 0) return
    
    codeMermaidEle.forEach(ele => {
      const preEle = document.createElement('pre')
      preEle.className = 'mermaid-src'
      preEle.hidden = true
      preEle.textContent = ele.textContent
      const newEle = document.createElement('div')
      newEle.className = 'mermaid-wrap'
      newEle.appendChild(preEle)
      ele.parentNode.replaceWith(newEle)
    })
  }

  const loadMermaid = () => {
    if (false) codeToMermaid()
    const $mermaid = document.querySelectorAll('#article-container .mermaid-wrap')
    if ($mermaid.length === 0) return

    const runMermaidFn = () => runMermaid($mermaid)
    btf.addGlobalFn('themeChange', runMermaidFn, 'mermaid')
    window.loadMermaid ? runMermaidFn() : btf.getScript('https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js').then(runMermaidFn)
  }
  
  btf.addGlobalFn('encrypt', loadMermaid, 'mermaid')
  window.pjax ? loadMermaid() : document.addEventListener('DOMContentLoaded', loadMermaid)
})()</script></div><script defer="defer" id="ribbon" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/canvas-ribbon.min.js" size="150" alpha="0.6" zIndex="-1" mobile="false" data-click="true"></script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>