<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>More Clustering?! | My Dearest</title><meta name="author" content="Animenzzzzzz"><meta name="copyright" content="Animenzzzzzz"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="Intro Hello again everyone! In this tutorial, we’re going to continue to work on clustering. When we left off in the last tutorial, we had the joiner node sending a hello message and the server nod">
<meta property="og:type" content="article">
<meta property="og:title" content="More Clustering?!">
<meta property="og:url" content="https://animenzzzzzz.github.io/pages/build-your-own-vm/32/index.html">
<meta property="og:site_name" content="My Dearest">
<meta property="og:description" content="Intro Hello again everyone! In this tutorial, we’re going to continue to work on clustering. When we left off in the last tutorial, we had the joiner node sending a hello message and the server nod">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://animenzzzzzz.github.io/img/avatar.jpg">
<meta property="article:published_time" content="2025-01-03T06:29:38.000Z">
<meta property="article:modified_time" content="2025-01-03T07:37:46.861Z">
<meta property="article:author" content="Animenzzzzzz">
<meta property="article:tag" content="virtual-machine">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://animenzzzzzz.github.io/img/avatar.jpg"><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="https://animenzzzzzz.github.io/pages/build-your-own-vm/32/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css"><script>(()=>{
      const saveToLocal = {
        set: (key, value, ttl) => {
          if (ttl === 0) return
          const now = Date.now()
          const expiry = now + ttl * 86400000
          const item = {
            value,
            expiry
          }
          localStorage.setItem(key, JSON.stringify(item))
        },
      
        get: key => {
          const itemStr = localStorage.getItem(key)
      
          if (!itemStr) {
            return undefined
          }
          const item = JSON.parse(itemStr)
          const now = Date.now()
      
          if (now > item.expiry) {
            localStorage.removeItem(key)
            return undefined
          }
          return item.value
        }
      }
      
      window.btf = {
        saveToLocal: saveToLocal,
        getScript: (url, attr = {}) => new Promise((resolve, reject) => {
          const script = document.createElement('script')
          script.src = url
          script.async = true
          script.onerror = reject
          script.onload = script.onreadystatechange = function() {
            const loadState = this.readyState
            if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
            script.onload = script.onreadystatechange = null
            resolve()
          }

          Object.keys(attr).forEach(key => {
            script.setAttribute(key, attr[key])
          })

          document.head.appendChild(script)
        }),

        getCSS: (url, id = false) => new Promise((resolve, reject) => {
          const link = document.createElement('link')
          link.rel = 'stylesheet'
          link.href = url
          if (id) link.id = id
          link.onerror = reject
          link.onload = link.onreadystatechange = function() {
            const loadState = this.readyState
            if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
            link.onload = link.onreadystatechange = null
            resolve()
          }
          document.head.appendChild(link)
        }),

        addGlobalFn: (key, fn, name = false, parent = window) => {
          const pjaxEnable = false
          if (!pjaxEnable && key.startsWith('pjax')) return

          const globalFn = parent.globalFn || {}
          const keyObj = globalFn[key] || {}
    
          if (name && keyObj[name]) return
    
          name = name || Object.keys(keyObj).length
          keyObj[name] = fn
          globalFn[key] = keyObj
          parent.globalFn = globalFn
        }
      }
    
      const activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      const activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }

      btf.activateDarkMode = activateDarkMode
      btf.activateLightMode = activateLightMode
      
      const t = saveToLocal.get('theme')
    
        if (t === 'dark') activateDarkMode()
        else if (t === 'light') activateLightMode()
      
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
      const detectApple = () => {
        if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
          document.documentElement.classList.add('apple')
        }
      }
      detectApple()
    })()</script><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false,"highlightFullpage":false,"highlightMacStyle":false},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  dateSuffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'null',
  Snackbar: undefined,
  infinitegrid: {
    js: 'https://cdn.jsdelivr.net/npm/@egjs/infinitegrid/dist/infinitegrid.min.js',
    buttonText: '加载更多'
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: false,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'More Clustering?!',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2025-01-03 15:37:46'
}</script><link rel="stylesheet" href="/css/font.css"><meta name="generator" content="Hexo 7.3.0"></head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="/img/avatar.jpg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">64</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">9</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">10</div></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url(/img/top_img.jpg);"><nav id="nav"><span id="blog-info"><a href="/" title="My Dearest"><span class="site-name">My Dearest</span></a></span><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div></div><div id="toggle-menu"><span class="site-page"><i class="fas fa-bars fa-fw"></i></span></div></div></nav><div id="post-info"><h1 class="post-title">More Clustering?!</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2025-01-03T06:29:38.000Z" title="发表于 2025-01-03 14:29:38">2025-01-03</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2025-01-03T07:37:46.861Z" title="更新于 2025-01-03 15:37:46">2025-01-03</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/Computer/">Computer</a><i class="fas fa-angle-right post-meta-separator"></i><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/Computer/Virtual-Machine/">Virtual Machine</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="More Clustering?!"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h2 id="intro">Intro</h2>
<p>Hello again everyone! In this tutorial, we’re going to continue to
work on clustering. When we left off in the last tutorial, we had the
joiner node sending a hello message and the server node adding it to its
list. The next tasks are:</p>
<ol type="1">
<li>Send a hello back</li>
<li>Send a list of all known nodes to the new joiner == Full-mesh
Network Remember how I mentioned we’d be doing a full mesh network? I
realized an illustration might be handy, so more beautiful text
art!</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">         ┌───────────────────────────────┐</span><br><span class="line">         │                               │</span><br><span class="line">         │                               ▼</span><br><span class="line">   ┌───────────┐                   ┌───────────┐</span><br><span class="line">   │           │                   │           │</span><br><span class="line">   │           │                   │           │</span><br><span class="line">┌─▶│   VM 1    │         ┌─────────│   VM 2    │</span><br><span class="line">│  │           │         │         │           │</span><br><span class="line">│  │           │         │         │           │</span><br><span class="line">│  └───────────┘         │         └───────────┘</span><br><span class="line">│        │               │               ▲</span><br><span class="line">│        │               │               │</span><br><span class="line">│        │               ▼               │</span><br><span class="line">│        │         ┌───────────┐         │</span><br><span class="line">│        │         │           │         │</span><br><span class="line">│        │         │           │         │</span><br><span class="line">│        └────────▶│   VM 3    │─────────┘</span><br><span class="line">│                  │           │</span><br><span class="line">│                  │           │</span><br><span class="line">│                  └───────────┘</span><br><span class="line">│                        │</span><br><span class="line">│                        │</span><br><span class="line">└────────────────────────┘</span><br></pre></td></tr></table></figure>
<p>See how each node is connected to every other node? This has
advantages and disadvantages:</p>
<h2 id="advantages">Advantages</h2>
<ol type="1">
<li>Relatively simple from a coding standpoint. You just send the entire
list to any new joiner. When one leaves, everyone knows about it and
removes it from their list.</li>
<li>With so many connections, the cluster has a high level of resiliency
to transient network issues.</li>
<li>Full-mesh topologies are easy to think about</li>
</ol>
<h2 id="disadvantages">Disadvantages</h2>
<ol type="1">
<li>TCP Connections to other nodes take a surprising amount of
resources. In terms of memory, this can be a few hundred to a few
thousand bytes.</li>
<li>Heartbeats</li>
</ol>
<p>That last one bears a longer explanation, so it gets a
subsection!</p>
<h2 id="heartbeats">Heartbeats</h2>
<p>In the diagram above, how does VM2 know that VM1 is up and running?
They send messages back and forth at regular intervals to communicate
their status. VM2 also does this to VM3. VM1 sends to VM2 and…​well, you
get the idea.</p>
<p>The more nodes you add, the more heartbeats are required simply for
the cluster to function. Historically, there’s been a limit of about 50
nodes to an Erlang cluster. One important thing to realize, though, is
that for the purposes of the heartbeats of those 50 nodes, it doesn’t
matter if they are 2 CPU, 2 GB of RAM tiny machines or a 128 CPU 5 TB of
RAM monster. This is one case where you can combine vertical and
horizontal scaling and get a lot of mileage.</p>
<h2 id="other-models">Other Models</h2>
<p>Yes, there are other models that would let us scale well beyond ~50
nodes. But we aren’t going to use them.</p>
<p>Yet.</p>
<p>These are more complex to implement, and for right now, this model
will work fine for our purposes.</p>
<h2 id="to-the-code">To the Code!</h2>
<p>Most of the work we’ll be doing is in the
<code>src/cluster/client.rs</code> file. We have the function
<code>send_hello</code>, which is fine. The function that receives it,
however is the <code>recv_loop</code> function, shown below:</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">run</span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>) &#123;</span><br><span class="line">    <span class="keyword">self</span>.<span class="title function_ invoke__">recv_loop</span>();</span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">buf</span> = <span class="type">String</span>::<span class="title function_ invoke__">new</span>();</span><br><span class="line">    <span class="keyword">loop</span> &#123;</span><br><span class="line">        <span class="keyword">match</span> <span class="keyword">self</span>.reader.<span class="title function_ invoke__">read_line</span>(&amp;<span class="keyword">mut</span> buf) &#123;</span><br><span class="line">            <span class="title function_ invoke__">Ok</span>(_) =&gt; &#123;</span><br><span class="line">                buf.<span class="title function_ invoke__">trim_right</span>();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="title function_ invoke__">Err</span>(e) =&gt; &#123;</span><br><span class="line">                <span class="built_in">println!</span>(<span class="string">&quot;Error receiving: &#123;:#?&#125;&quot;</span>, e);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Note how in our <code>run</code> function we enter an infinite loop
trying to read from a socket. Right now, all we do is trim the buffer,
but we actually need to process the message. Which means we need a
protocol!</p>
<h2 id="protocol">Protocol</h2>
<p>A Protocol simply a defined way for two things to communicate. We
could use JSON, and send that back and forth. We could use YAML,
Protobuf, Capnproto, or many others. Since we are doing this to learn
low level coding, let’s make our own simple protocol.</p>
<h2 id="the-blank-canvas">The Blank Canvas</h2>
<p>We are artistes! We can do whatever we want! Let’s start by
allocating 1 byte at the front of our messages to indicate the type of
message. That gives us 2^8, or 256 types of messages.</p>
<p>It would look like this: [0, 0, 0, 0, 0, 0, 0, 0]. That’s 8 bits, or
1 byte. If we treat it as a u8, it is equal to 0.</p>
<p>What about a message that sends a list of all known nodes? Why, that
can be number 1: [0, 0, 0, 0, 0, 0, 0, 1].</p>
<h2 id="but-the-list">But The List…​</h2>
<p>This is where we have to extend our protocol. We can say that the
next byte that follows contains the number of nodes in the cluster. If
it is a three node cluster, we’d then have:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 1, 1]</span><br></pre></td></tr></table></figure>
<p>If our receiver sees a message of type 1, then we code in logic that
tells it to expect the number of nodes in the next byte. After that, the
node can send its entire list.</p>
<p>Suppose we used a UUID for each node. We know a UUID takes up 128
bits. As a new joiner to the cluster, when we receive the message of
type 1, followed by 3, we know that we should expect 128 * 3 more
bits.</p>
<h2 id="well-this-sounds-tedious">Well This Sounds Tedious</h2>
<p>Well, yes. Happily, we can do all this rather easily by using Rust to
serialize data. The heavyweight tool in Rust for that is called
<code>serde</code>. We’ll use it to serialize our messages into
something called <code>bincode</code>, which is a compact Rust-specific
encoding scheme.</p>
<blockquote>
<p><code>serde</code> has support for TOML, JSON, YAML, and a bunch of
others. We’re using bincode for ease and compactness.</p>
</blockquote>
<h2 id="the-tasks">The Tasks</h2>
<ol type="1">
<li>Define a message enum</li>
<li>Write a message interpreter</li>
</ol>
<h3 id="message-enum">Message Enum</h3>
<p>If you take a look in <code>src/cluster/message.rs</code>, you’ll see
we already started on this. It looks like this:</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">pub</span> <span class="keyword">enum</span> <span class="title class_">IridiumMessage</span> &#123;</span><br><span class="line">    Hello &#123;</span><br><span class="line">        alias: <span class="type">String</span>,</span><br><span class="line">    &#125;,</span><br><span class="line">    HelloAck &#123;</span><br><span class="line">        alias: <span class="type">String</span>,</span><br><span class="line">        nodes: <span class="type">Vec</span>&lt;(<span class="type">String</span>, <span class="type">String</span>, <span class="type">String</span>)&gt;,</span><br><span class="line">    &#125;,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Note how we are sending a Vector of tuples containing three Strings.
The first is the alias, the second the IP, the third the port.</p>
<blockquote>
<p>We could take advantage of type aliasing here to make this more
clear. Feel free to try, and take a look at the source if you need some
help.</p>
</blockquote>
<p>We need to add three dependencies to <code>Cargo.toml</code>:</p>
<figure class="highlight toml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">bincode</span> = <span class="string">&quot;1.0.1&quot;</span></span><br><span class="line"><span class="attr">serde</span> = <span class="string">&quot;1.0.80&quot;</span></span><br><span class="line"><span class="attr">serde_derive</span> = <span class="string">&quot;1.0.80&quot;</span></span><br></pre></td></tr></table></figure>
<p><code>bincode</code> adds in the encoding functionality,
<code>serde</code> adds the core serialization functionality, and
serde_derive will allow us to derive the <code>Serialize</code> and
<code>Deserialize</code> Traits needed by <code>bincode</code>.</p>
<p>After adding those to Cargo.toml, we’ll need to add them to
<code>src/bin/iridium.rs</code> and <code>src/lib.rs</code> like so:</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">extern</span> <span class="keyword">crate</span> bincode;</span><br><span class="line"><span class="meta">#[macro_use]</span></span><br><span class="line"><span class="keyword">extern</span> <span class="keyword">crate</span> serde_derive;</span><br><span class="line"><span class="keyword">extern</span> <span class="keyword">crate</span> serde;</span><br></pre></td></tr></table></figure>
<h3 id="serialization">Serialization</h3>
<p>Now we can change our enum to be:</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#[derive(Serialize, Deserialize, Debug)]</span></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">enum</span> <span class="title class_">IridiumMessage</span> &#123;</span><br><span class="line">    Hello &#123;</span><br><span class="line">        alias: <span class="type">String</span>,</span><br><span class="line">    &#125;,</span><br><span class="line">    HelloAck &#123;</span><br><span class="line">        alias: <span class="type">String</span>,</span><br><span class="line">        nodes: <span class="type">Vec</span>&lt;(<span class="type">String</span>, <span class="type">String</span>, <span class="type">String</span>)&gt;,</span><br><span class="line">    &#125;,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Notice how we can now derive the needed traits.</p>
<h3 id="generating-messages">Generating Messages</h3>
<p>Back over in <code>message.rs</code>, we can now implement functions
to generate and serialize messages. To generate the <code>hello</code>
message, we can do:</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">impl</span> <span class="title class_">IridiumMessage</span> &#123;</span><br><span class="line">    <span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">hello</span>(alias: &amp;<span class="type">str</span>) <span class="punctuation">-&gt;</span> <span class="type">Result</span>&lt;<span class="type">Vec</span>&lt;<span class="type">u8</span>&gt;&gt; &#123;</span><br><span class="line">        <span class="keyword">let</span> <span class="variable">new_message</span> = IridiumMessage::Hello&#123;</span><br><span class="line">            alias: alias.<span class="title function_ invoke__">into</span>()</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="title function_ invoke__">serialize</span>(&amp;new_message)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>What we’ll get back is a <code>Vec&lt;u8&gt;</code> that contains the
alias, which we can send over a socket. If you look in
<code>client.rs</code>, you can see our first <code>send_hello</code>
function. We can replace it with:</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">send_hello</span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>) &#123;</span><br><span class="line">    <span class="keyword">match</span> <span class="keyword">self</span>.alias &#123;</span><br><span class="line">        <span class="title function_ invoke__">Some</span>(<span class="keyword">ref</span> alias) =&gt; &#123;</span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">let</span> <span class="variable">Ok</span>(hello) = IridiumMessage::<span class="title function_ invoke__">hello</span>(alias) &#123;</span><br><span class="line">                <span class="keyword">if</span> <span class="keyword">self</span>.raw_stream.<span class="title function_ invoke__">write</span>(&amp;hello).<span class="title function_ invoke__">is_ok</span>() &#123;</span><br><span class="line">                    trace!(<span class="string">&quot;Hello sent!&quot;</span>);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    error!(<span class="string">&quot;Error sending hello&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="literal">None</span> =&gt; &#123;</span><br><span class="line">            error!(<span class="string">&quot;Node has no ID to send hello&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>This uses our IridiumMessage enum to generate and send the
message.</p>
<h3 id="hello-ack">Hello Ack</h3>
<p>We need a function to respond to the <code>hello</code>. Try and
implement it yourself, but check out <code>messages.rs</code> if you get
stuck. Note that I added the following convience functions in
<code>client.rs</code> to help with it:</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">alias_as_string</span>(&amp;<span class="keyword">self</span>) <span class="punctuation">-&gt;</span> <span class="type">Option</span>&lt;<span class="type">String</span>&gt;;</span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">ip_as_string</span>(&amp;<span class="keyword">self</span>) <span class="punctuation">-&gt;</span> <span class="type">Option</span>&lt;<span class="type">String</span>&gt;;</span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">port_as_string</span>(&amp;<span class="keyword">self</span>) <span class="punctuation">-&gt;</span> <span class="type">Option</span>&lt;<span class="type">String</span>&gt;;</span><br></pre></td></tr></table></figure>
<h3 id="receiving-messages">Receiving Messages</h3>
<p>The hard part of this is done. We have a receive loop in place that
listens for incoming packets. All we need is a deserializer, which we
can put in the IridiumMessage impl as well.</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">process_message</span>(message: &amp;[<span class="type">u8</span>]) <span class="punctuation">-&gt;</span> <span class="type">Result</span>&lt;IridiumMessage&gt; &#123;</span><br><span class="line">    <span class="title function_ invoke__">deserialize</span>(message)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Yup, that’s really it. =)</p>
<p>Over in <code>message.rs</code>, we need to change our run function a
bit:</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">run</span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>) &#123;</span><br><span class="line">    <span class="keyword">self</span>.<span class="title function_ invoke__">recv_loop</span>();</span><br><span class="line">    <span class="keyword">loop</span> &#123;</span><br><span class="line">        <span class="keyword">let</span> <span class="variable">result</span>: bincode::<span class="type">Result</span>&lt;IridiumMessage&gt; = bincode::<span class="title function_ invoke__">deserialize_from</span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>.reader);</span><br><span class="line">        <span class="keyword">match</span> result &#123;</span><br><span class="line">            <span class="title function_ invoke__">Ok</span>(<span class="keyword">ref</span> message) =&gt; &#123;</span><br><span class="line">                <span class="keyword">match</span> message &#123;</span><br><span class="line">                    &amp;IridiumMessage::HelloAck&#123;<span class="keyword">ref</span> nodes, <span class="keyword">ref</span> alias&#125; =&gt; &#123;</span><br><span class="line">                        debug!(<span class="string">&quot;Received list of nodes: &#123;:?&#125; from &#123;:?&#125;&quot;</span>, nodes, alias);</span><br><span class="line">                    &#125;,</span><br><span class="line">                    _ =&gt; &#123;</span><br><span class="line">                        error!(<span class="string">&quot;Unknown message received&quot;</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                debug!(<span class="string">&quot;Received message: &#123;:?&#125;&quot;</span>, message);</span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="title function_ invoke__">Err</span>(e) =&gt; &#123;</span><br><span class="line">                error!(<span class="string">&quot;Error deserializing Iridium message: &#123;:?&#125;&quot;</span>, e);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Don’t forget to add a <code>use bincode;</code> at the top! And note
how match on the type of message we decode here. We also have to change
our <code>listen</code> function in <code>server.rs</code> a bit:</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">listen</span>(my_alias: <span class="type">String</span>, addr: SocketAddr, connection_manager: Arc&lt;RwLock&lt;Manager&gt;&gt;) &#123;</span><br><span class="line">    info!(<span class="string">&quot;Initializing Cluster server...&quot;</span>);</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">listener</span> = TcpListener::<span class="title function_ invoke__">bind</span>(addr).<span class="title function_ invoke__">unwrap</span>();</span><br><span class="line">    <span class="keyword">for</span> <span class="variable">stream</span> <span class="keyword">in</span> listener.<span class="title function_ invoke__">incoming</span>() &#123;</span><br><span class="line">        <span class="keyword">let</span> <span class="variable">tmp_alias</span> = my_alias.<span class="title function_ invoke__">clone</span>();</span><br><span class="line">        <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">cmgr</span> = connection_manager.<span class="title function_ invoke__">clone</span>();</span><br><span class="line">        info!(<span class="string">&quot;New Node connected!&quot;</span>);</span><br><span class="line">        <span class="keyword">let</span> <span class="variable">stream</span> = stream.<span class="title function_ invoke__">unwrap</span>();</span><br><span class="line">        thread::<span class="title function_ invoke__">spawn</span>(<span class="keyword">move</span> || &#123;</span><br><span class="line">            <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">client</span> = ClusterClient::<span class="title function_ invoke__">new</span>(stream);</span><br><span class="line">            <span class="keyword">let</span> <span class="variable">result</span>: bincode::<span class="type">Result</span>&lt;IridiumMessage&gt; = bincode::<span class="title function_ invoke__">deserialize_from</span>(&amp;<span class="keyword">mut</span> client.reader);</span><br><span class="line">            <span class="keyword">match</span> result &#123;</span><br><span class="line">                <span class="title function_ invoke__">Ok</span>(message) =&gt; &#123;</span><br><span class="line">                    <span class="keyword">match</span> message &#123;</span><br><span class="line">                        IridiumMessage::Hello&#123;alias&#125; =&gt; &#123;</span><br><span class="line">                            debug!(<span class="string">&quot;Found a hello message with alias: &#123;:?&#125;&quot;</span>, alias);</span><br><span class="line">                            <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">cmgr_lock</span> = cmgr.<span class="title function_ invoke__">write</span>().<span class="title function_ invoke__">unwrap</span>();</span><br><span class="line">                            <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">members</span>: <span class="type">Vec</span>&lt;(<span class="type">String</span>, <span class="type">String</span>, <span class="type">String</span>)&gt; = <span class="type">Vec</span>::<span class="title function_ invoke__">new</span>();</span><br><span class="line">                        </span><br><span class="line">                            <span class="comment">// Now we need to send back a list of cluster members in the form of a Vector of tuples, containing their alias</span></span><br><span class="line">                            <span class="keyword">for</span> (key, value) <span class="keyword">in</span> &amp;cmgr_lock.clients &#123;</span><br><span class="line">                                <span class="keyword">if</span> <span class="keyword">let</span> <span class="variable">Ok</span>(client) = value.<span class="title function_ invoke__">read</span>() &#123;</span><br><span class="line">                                    <span class="keyword">let</span> <span class="variable">tuple</span> = (key.<span class="title function_ invoke__">to_string</span>(), client.<span class="title function_ invoke__">ip_as_string</span>().<span class="title function_ invoke__">unwrap</span>(), client.<span class="title function_ invoke__">port_as_string</span>().<span class="title function_ invoke__">unwrap</span>());</span><br><span class="line">                                    members.<span class="title function_ invoke__">push</span>(tuple);</span><br><span class="line">                                &#125;</span><br><span class="line">                            &#125;</span><br><span class="line">                            <span class="keyword">let</span> <span class="variable">hello_ack</span> = IridiumMessage::HelloAck &#123;</span><br><span class="line">                                nodes: members,</span><br><span class="line">                                alias: (tmp_alias.<span class="title function_ invoke__">clone</span>(), addr.<span class="title function_ invoke__">ip</span>().<span class="title function_ invoke__">to_string</span>(), addr.<span class="title function_ invoke__">port</span>().<span class="title function_ invoke__">to_string</span>())</span><br><span class="line">                            &#125;;</span><br><span class="line"></span><br><span class="line">                            client.<span class="title function_ invoke__">write_bytes</span>(&amp;bincode::<span class="title function_ invoke__">serialize</span>(&amp;hello_ack).<span class="title function_ invoke__">unwrap</span>());</span><br><span class="line">                            cmgr_lock.<span class="title function_ invoke__">add_client</span>(alias.<span class="title function_ invoke__">to_string</span>(), client);</span><br><span class="line">                        &#125;,</span><br><span class="line">                        _ =&gt; &#123;</span><br><span class="line">                            error!(<span class="string">&quot;Non-hello message received from node trying to join&quot;</span>);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;,</span><br><span class="line">                <span class="title function_ invoke__">Err</span>(e) =&gt; &#123;</span><br><span class="line">                    error!(<span class="string">&quot;Error deserializing Iridium message: &#123;:?&#125;&quot;</span>, e);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>This can be cleaned up a lot.</p>
</blockquote>
<p>The problem we have is that this is the bootstrapping process. A node
has to say Hello, then get back a list of nodes. It is easier to do this
logic here, and then once we are sure everything is in order, we can use
client functions to send.</p>
<p>At this point, we should be able to start up two Iridium VMs, have
one try to join, and see the hello, and get back a list of nodes. Let’s
give it a try!</p>
<p>From the VM where I started the cluster:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Welcome to Iridium! Let<span class="string">&#x27;s be productive!</span></span><br><span class="line"><span class="string">&gt;&gt;&gt; !start_cluster</span></span><br><span class="line"><span class="string">Started cluster server!</span></span><br><span class="line"><span class="string">&gt;&gt;&gt;  INFO 2018-10-28T03:20:32Z: iridium::cluster::server: Initializing Cluster server...</span></span><br><span class="line"><span class="string"> INFO 2018-10-28T03:20:41Z: iridium::cluster::server: New Node connected!</span></span><br><span class="line"><span class="string">DEBUG 2018-10-28T03:20:41Z: iridium::cluster::server: Found a hello message with alias: &quot;b1ff4bc1-0d72-4d1e-95f3-f384b33f5c2e&quot;</span></span><br></pre></td></tr></table></figure>
<p>And from another VM where I joined the original node:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt; !join_cluster localhost 2254</span><br><span class="line">Attempting to <span class="built_in">join</span> cluster...</span><br><span class="line">Connected to cluster!</span><br><span class="line">TRACE 2018-10-28T03:20:41Z: iridium::cluster::message: Generating hello message</span><br><span class="line">TRACE 2018-10-28T03:20:41Z: iridium::cluster::client: Hello sent: [0, 0, 0, 0, 36, 0, 0, 0, 0, 0, 0, 0, 98, 49, 102, 102, 52, 98, 99, 49, 45, 48, 100, 55, 50, 45, 52, 100, 49, 101, 45, 57, 53, 102, 51, 45, 102, 51, 56, 52, 98, 51, 51, 102, 53, 99, 50, 101]</span><br><span class="line">&gt;&gt;&gt; DEBUG 2018-10-28T03:20:41Z: iridium::cluster::client: Received list of nodes: [] from (<span class="string">&quot;&quot;</span>, <span class="string">&quot;127.0.0.1&quot;</span>, <span class="string">&quot;2254&quot;</span>)</span><br><span class="line">DEBUG 2018-10-28T03:20:41Z: iridium::cluster::client: Received message: HelloAck &#123; <span class="built_in">alias</span>: (<span class="string">&quot;&quot;</span>, <span class="string">&quot;127.0.0.1&quot;</span>, <span class="string">&quot;2254&quot;</span>), nodes: [] &#125;</span><br></pre></td></tr></table></figure>
<p>Yay! It worked! We are successfully deserializing bincoded structs
sent over the network.</p>
<p>Because we only have two nodes, and a node doesn’t add itself to the
connection list, we have to send it separately in the alias field. And
that’s why the node list is empty.</p>
<h2 id="end">End</h2>
<p>We’re getting closer! Clustering is finnicky, but we’re almost there.
The listen function is getting pretty awful, so we’ll probably refactor
that sooner rather than later.</p>
<p>We also need to handle disconnections. If you close one of the VMs
right now, you’ll see a stream of error messages. But, that’s another
tutorial!</p>
<p>refer to <a
target="_blank" rel="noopener" href="https://blog.subnetzero.io/post/building-language-vm-part-32/">building-language-vm</a></p>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta"><i class="fas fa-circle-user fa-fw"></i>文章作者: </span><span class="post-copyright-info"><a href="https://animenzzzzzz.github.io">Animenzzzzzz</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta"><i class="fas fa-square-arrow-up-right fa-fw"></i>文章链接: </span><span class="post-copyright-info"><a href="https://animenzzzzzz.github.io/pages/build-your-own-vm/32/">https://animenzzzzzz.github.io/pages/build-your-own-vm/32/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta"><i class="fas fa-circle-exclamation fa-fw"></i>版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://animenzzzzzz.github.io" target="_blank">My Dearest</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/virtual-machine/">virtual-machine</a></div><div class="post-share"><div class="social-share" data-image="/img/avatar.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><a class="prev-post pull-left" href="/pages/build-your-own-vm/31/" title="Making Clustering Make Sense"><div class="cover" style="background: var(--default-bg-color)"></div><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">Making Clustering Make Sense</div></div></a><a class="next-post pull-right" href="/pages/build-your-own-vm/33/" title="Cluster Syncing"><div class="cover" style="background: var(--default-bg-color)"></div><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">Cluster Syncing</div></div></a></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class="relatedPosts-list"><a href="/pages/build-your-own-vm/00/" title="Computer Hardware Crash Course"><div class="cover" style="background: var(--default-bg-color)"></div><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2024-11-19</div><div class="title">Computer Hardware Crash Course</div></div></a><a href="/pages/build-your-own-vm/01/" title="Overview and a Simple VM"><div class="cover" style="background: var(--default-bg-color)"></div><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2024-12-20</div><div class="title">Overview and a Simple VM</div></div></a><a href="/pages/build-your-own-vm/03/" title="More Basic Opcodes"><div class="cover" style="background: var(--default-bg-color)"></div><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2024-12-20</div><div class="title">More Basic Opcodes</div></div></a><a href="/pages/build-your-own-vm/02/" title="Basic Opcodes"><div class="cover" style="background: var(--default-bg-color)"></div><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2024-12-20</div><div class="title">Basic Opcodes</div></div></a><a href="/pages/build-your-own-vm/04/" title="Jumps"><div class="cover" style="background: var(--default-bg-color)"></div><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2024-12-24</div><div class="title">Jumps</div></div></a><a href="/pages/build-your-own-vm/05/" title="Equality Checks"><div class="cover" style="background: var(--default-bg-color)"></div><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2024-12-24</div><div class="title">Equality Checks</div></div></a></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info is-center"><div class="avatar-img"><img src="/img/avatar.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info-name">Animenzzzzzz</div><div class="author-info-description">向来如此，便对么？</div><div class="site-data"><a href="/archives/"><div class="headline">文章</div><div class="length-num">64</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">9</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">10</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/Animenzzzzzz"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons"><a class="social-icon" href="https://github.com/Animenzzzzzz" target="_blank" title="Github"><i class="fab fa-github" style="color: #24292e;"></i></a><a class="social-icon" href="mailto:jinnianqianyin@outlook.com" target="_blank" title="Email"><i class="fas fa-envelope" style="color: #4a7dbe;"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>公告</span></div><div class="announcement_content">嘿咻~嘿咻~</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#intro"><span class="toc-number">1.</span> <span class="toc-text">Intro</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#advantages"><span class="toc-number">2.</span> <span class="toc-text">Advantages</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#disadvantages"><span class="toc-number">3.</span> <span class="toc-text">Disadvantages</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#heartbeats"><span class="toc-number">4.</span> <span class="toc-text">Heartbeats</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#other-models"><span class="toc-number">5.</span> <span class="toc-text">Other Models</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#to-the-code"><span class="toc-number">6.</span> <span class="toc-text">To the Code!</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#protocol"><span class="toc-number">7.</span> <span class="toc-text">Protocol</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#the-blank-canvas"><span class="toc-number">8.</span> <span class="toc-text">The Blank Canvas</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#but-the-list"><span class="toc-number">9.</span> <span class="toc-text">But The List…​</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#well-this-sounds-tedious"><span class="toc-number">10.</span> <span class="toc-text">Well This Sounds Tedious</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#the-tasks"><span class="toc-number">11.</span> <span class="toc-text">The Tasks</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#message-enum"><span class="toc-number">11.1.</span> <span class="toc-text">Message Enum</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#serialization"><span class="toc-number">11.2.</span> <span class="toc-text">Serialization</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#generating-messages"><span class="toc-number">11.3.</span> <span class="toc-text">Generating Messages</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#hello-ack"><span class="toc-number">11.4.</span> <span class="toc-text">Hello Ack</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#receiving-messages"><span class="toc-number">11.5.</span> <span class="toc-text">Receiving Messages</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#end"><span class="toc-number">12.</span> <span class="toc-text">End</span></a></li></ol></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2024 - 2025 By Animenzzzzzz</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><div class="js-pjax"><script>(() => {
  const runMermaid = (ele) => {
    window.loadMermaid = true
    const theme = document.documentElement.getAttribute('data-theme') === 'dark' ? 'dark' : 'default'

    Array.from(ele).forEach((item, index) => {
      const mermaidSrc = item.firstElementChild
      const mermaidThemeConfig = '%%{init:{ \'theme\':\'' + theme + '\'}}%%\n'
      const mermaidID = 'mermaid-' + index
      const mermaidDefinition = mermaidThemeConfig + mermaidSrc.textContent

      const renderFn = mermaid.render(mermaidID, mermaidDefinition)
      const renderMermaid = svg => {
        mermaidSrc.insertAdjacentHTML('afterend', svg)
      }

      // mermaid v9 and v10 compatibility
      typeof renderFn === 'string' ? renderMermaid(renderFn) : renderFn.then(({svg}) => renderMermaid(svg))
    })
  }

  const codeToMermaid = () => {
    const codeMermaidEle = document.querySelectorAll('pre > code.mermaid')
    if (codeMermaidEle.length === 0) return
    
    codeMermaidEle.forEach(ele => {
      const preEle = document.createElement('pre')
      preEle.className = 'mermaid-src'
      preEle.hidden = true
      preEle.textContent = ele.textContent
      const newEle = document.createElement('div')
      newEle.className = 'mermaid-wrap'
      newEle.appendChild(preEle)
      ele.parentNode.replaceWith(newEle)
    })
  }

  const loadMermaid = () => {
    if (false) codeToMermaid()
    const $mermaid = document.querySelectorAll('#article-container .mermaid-wrap')
    if ($mermaid.length === 0) return

    const runMermaidFn = () => runMermaid($mermaid)
    btf.addGlobalFn('themeChange', runMermaidFn, 'mermaid')
    window.loadMermaid ? runMermaidFn() : btf.getScript('https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js').then(runMermaidFn)
  }
  
  btf.addGlobalFn('encrypt', loadMermaid, 'mermaid')
  window.pjax ? loadMermaid() : document.addEventListener('DOMContentLoaded', loadMermaid)
})()</script></div><script defer="defer" id="ribbon" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/canvas-ribbon.min.js" size="150" alpha="0.6" zIndex="-1" mobile="false" data-click="true"></script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>